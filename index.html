<!DOCTYPE html>
<html lang="en">
<!--
    ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
    ‚ïë                  EMMETT O'BRIEN SIMULATOR                            ‚ïë
    ‚ïë                                                                      ‚ïë
    ‚ïë  üåê GLOBAL LEADERBOARD: ‚úÖ ENABLED                                   ‚ïë
    ‚ïë                                                                      ‚ïë
    ‚ïë  Firebase is configured and ready to go!                            ‚ïë
    ‚ïë  All players worldwide can compete on the same leaderboard.         ‚ïë
    ‚ïë                                                                      ‚ïë
    ‚ïë  üìä View your database at:                                           ‚ïë
    ‚ïë  https://console.firebase.google.com/project/emmett-obrien-game     ‚ïë
    ‚ïë                                                                      ‚ïë
    ‚ïë  The leaderboard will automatically sync when players:              ‚ïë
    ‚ïë  - Log in to an account                                             ‚ïë
    ‚ïë  - Complete orders                                                  ‚ïë
    ‚ïë  - Buy upgrades                                                     ‚ïë
    ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
-->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Emmett O'Brien Simulator</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            max-width: 800px;
            width: 100%;
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            color: #c8102e;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .bor-icon {
            font-size: 0.6em;
            background: #f9f7f1;
            border: 2px solid #d4af37;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .logged-in-status {
            display: none;
            background: #e8f5e9;
            color: #2e7d32;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
        }

        .logged-in-status.active {
            display: inline-block;
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #c8102e 0%, #da291c 100%);
            border-radius: 15px;
            color: white;
        }

        .stat-box {
            text-align: center;
        }

        .stat-box .label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-box .value {
            font-size: 2em;
            font-weight: bold;
        }

        .order-area {
            background: #f8f8f8;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            min-height: 200px;
        }

        .current-order {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 3px solid #ffc72c;
            margin-bottom: 20px;
        }

        .current-order h3 {
            color: #c8102e;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .order-items {
            list-style: none;
            margin-bottom: 15px;
        }

        .order-items li {
            padding: 8px;
            margin: 5px 0;
            background: #fff8dc;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50 0%, #8bc34a 100%);
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .button-area {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .shop-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1.2em;
            box-shadow: 0 5px 20px rgba(156, 39, 176, 0.4);
            z-index: 100;
        }

        .shop-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(156, 39, 176, 0.6);
        }

        .account-button {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1.2em;
            box-shadow: 0 5px 20px rgba(33, 150, 243, 0.4);
            z-index: 100;
        }

        .account-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(33, 150, 243, 0.6);
        }

        .leaderboard-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 1.2em;
            box-shadow: 0 5px 20px rgba(255, 152, 0, 0.4);
            z-index: 100;
        }

        .leaderboard-button:hover {
            transform: translateX(-50%) translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 152, 0, 0.6);
        }

        .settings-button {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #607d8b 0%, #455a64 100%);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            font-size: 1.1em;
            box-shadow: 0 5px 20px rgba(96, 125, 139, 0.4);
            z-index: 100;
            cursor: pointer;
            border: none;
        }

        .settings-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(96, 125, 139, 0.6);
        }

        .leaderboard-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .leaderboard-content {
            background: white;
            max-width: 900px;
            margin: 50px auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(255, 152, 0, 0.5);
        }

        .leaderboard-content h2 {
            color: #ff9800;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-align: center;
        }

        .leaderboard-subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        .leaderboard-table thead {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
        }

        .leaderboard-table th {
            padding: 15px;
            text-align: left;
            font-weight: bold;
        }

        .leaderboard-table th:first-child {
            text-align: center;
            width: 60px;
        }

        .leaderboard-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .leaderboard-table td:first-child {
            text-align: center;
            font-weight: bold;
            color: #ff9800;
        }

        .leaderboard-table tr:hover {
            background: #fff8e1;
        }

        .leaderboard-rank {
            display: inline-block;
            min-width: 30px;
        }

        .rank-1 {
            color: #ffd700 !important;
            font-size: 1.3em;
        }

        .rank-2 {
            color: #c0c0c0 !important;
            font-size: 1.2em;
        }

        .rank-3 {
            color: #cd7f32 !important;
            font-size: 1.1em;
        }

        .leaderboard-username {
            font-weight: bold;
            color: #333;
        }

        .leaderboard-title {
            color: #9c27b0;
            font-size: 0.9em;
            font-style: italic;
            margin-left: 8px;
        }

        .current-user-row {
            background: #e3f2fd !important;
            border-left: 4px solid #2196f3;
        }

        .current-user-row td:first-child {
            color: #2196f3 !important;
        }

        .trophy-icon {
            margin-right: 5px;
        }

        .no-data-message {
            text-align: center;
            padding: 40px;
            color: #999;
            font-size: 1.2em;
        }

        .shop-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .shop-content {
            background: white;
            max-width: 900px;
            margin: 50px auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(156, 39, 176, 0.5);
        }

        .shop-content h2 {
            color: #9c27b0;
            font-size: 2.5em;
            margin-bottom: 30px;
            text-align: center;
        }

        .shop-items {
            display: grid;
            gap: 20px;
        }

        .shop-item {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            padding: 25px;
            border-radius: 10px;
            border-left: 5px solid #9c27b0;
        }

        .shop-item h3 {
            color: #9c27b0;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .shop-item p {
            color: #555;
            margin-bottom: 15px;
            line-height: 1.6;
        }

        .shop-item-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .price {
            font-weight: bold;
            font-size: 1.2em;
            color: #9c27b0;
        }

        .buy-button {
            background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
            color: white;
            padding: 10px 25px;
            border-radius: 8px;
        }

        .buy-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(156, 39, 176, 0.4);
        }

        .buy-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .buy-buttons-container {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .buy-max-button {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .buy-max-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 152, 0, 0.4);
        }

        .buy-max-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .achievements-section {
            background: #f8f8f8;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .achievements-section h3 {
            color: #9c27b0;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .badges {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .badge {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            padding: 15px 20px;
            border-radius: 10px;
            border: 3px solid #d4af37;
            font-weight: bold;
            color: #333;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge-icon {
            font-size: 1.5em;
        }

        .bots-active {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 5px solid #2196f3;
        }

        .bots-active h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .bot-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            color: #555;
        }

        .account-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .account-content {
            background: white;
            max-width: 700px;
            margin: 100px auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(33, 150, 243, 0.5);
        }

        .account-content h2 {
            color: #2196f3;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .auth-view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .auth-view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        .tab-button {
            flex: 1;
            padding: 12px;
            background: #f5f5f5;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button.active {
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: bold;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #2196f3;
        }

        .submit-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submit-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.4);
        }

        .logged-in-view {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .logged-in-view.active {
            display: block;
        }

        .profile-header {
            text-align: center;
            background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 25px;
        }

        .profile-header h3 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .profile-header .username {
            font-size: 1.5em;
            font-weight: bold;
        }

        .profile-header .member-since {
            font-size: 0.9em;
            opacity: 0.9;
            margin-top: 5px;
        }

        .brecken-badge {
            display: inline-block;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: bold;
            margin-top: 10px;
            border: 2px solid #d4af37;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border-left: 4px solid #2196f3;
        }

        .stat-card .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-card .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            color: #2196f3;
        }

        .profile-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .profile-section h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.2em;
            border-bottom: 2px solid #2196f3;
            padding-bottom: 8px;
        }

        .shop-items-owned {
            display: grid;
            gap: 10px;
        }

        .owned-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 3px solid #4caf50;
        }

        .owned-item .item-name {
            font-weight: bold;
            color: #333;
        }

        .owned-item .item-count {
            background: #4caf50;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.9em;
        }

        .multipliers-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .multiplier-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .multiplier-box .mult-label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }

        .multiplier-box .mult-value {
            font-size: 2em;
            font-weight: bold;
            color: #ff9800;
        }

        .logout-button {
            width: 100%;
            padding: 12px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .logout-button:hover {
            background: #d32f2f;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .success-message {
            background: #e8f5e9;
            color: #2e7d32;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .title-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1100;
            overflow-y: auto;
            padding: 20px;
        }

        .title-content {
            background: white;
            max-width: 600px;
            margin: 100px auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(156, 39, 176, 0.5);
        }

        .title-content h2 {
            color: #9c27b0;
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
        }

        .titles-list {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .title-item {
            background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #9c27b0;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .title-item:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }

        .title-item.selected {
            border-left-color: #4caf50;
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }

        .title-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
            border-left-color: #999;
        }

        .title-item.locked:hover {
            transform: none;
        }

        .title-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .title-name {
            font-weight: bold;
            font-size: 1.2em;
            color: #333;
        }

        .title-badge {
            background: #4caf50;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
        }

        .title-badge.locked-badge {
            background: #999;
        }

        .title-requirement {
            color: #666;
            font-size: 0.95em;
        }

        .user-title-display {
            color: #9c27b0;
            font-size: 0.8em;
            font-weight: normal;
            display: block;
            margin-top: 5px;
            cursor: pointer;
            text-decoration: underline;
        }

        .user-title-display:hover {
            color: #7b1fa2;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .make-button {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
            color: white;
            flex: 1;
        }

        .make-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
        }

        .make-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .complete-button {
            background: linear-gradient(135deg, #ffc72c 0%, #ffb700 100%);
            color: #333;
            flex: 1;
        }

        .complete-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 199, 44, 0.4);
        }

        .complete-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .bill-of-rights-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .bill-of-rights-content {
            background: #f9f7f1;
            max-width: 900px;
            margin: 50px auto;
            padding: 50px;
            border-radius: 10px;
            box-shadow: 0 0 50px rgba(255,215,0,0.5);
            border: 3px solid #d4af37;
        }

        .bill-of-rights-content h2 {
            text-align: center;
            color: #1a1a1a;
            font-size: 2.5em;
            margin-bottom: 30px;
            font-family: 'Georgia', serif;
        }

        .amendment {
            margin-bottom: 25px;
            padding: 20px;
            background: white;
            border-left: 5px solid #c8102e;
            border-radius: 5px;
        }

        .amendment h3 {
            color: #c8102e;
            margin-bottom: 10px;
            font-family: 'Georgia', serif;
        }

        .amendment p {
            line-height: 1.8;
            color: #333;
            font-size: 1.05em;
        }

        .close-button {
            display: block;
            margin: 30px auto 0;
            background: #c8102e;
            color: white;
            padding: 15px 40px;
        }

        .close-button:hover {
            background: #a00d24;
        }

        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }

        .settings-content {
            background: white;
            max-width: 500px;
            margin: 100px auto;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 0 50px rgba(96, 125, 139, 0.5);
        }

        .settings-content h2 {
            color: #607d8b;
            font-size: 2em;
            margin-bottom: 10px;
            text-align: center;
        }

        .settings-section {
            margin: 30px 0;
        }

        .settings-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .settings-item-label {
            display: flex;
            flex-direction: column;
        }

        .settings-item-label h3 {
            font-size: 1.2em;
            color: #333;
            margin-bottom: 5px;
        }

        .settings-item-label p {
            font-size: 0.9em;
            color: #666;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: #4caf50;
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .congrats-message {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .congrats-message h3 {
            color: #c8102e;
            font-size: 1.8em;
            margin-bottom: 10px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .pulse {
            animation: pulse 0.5s ease;
        }

        @keyframes gemFloat {
            0% {
                transform: translateY(0) scale(0.5);
                opacity: 0;
            }
            50% {
                transform: translateY(-30px) scale(1.2);
                opacity: 1;
            }
            100% {
                transform: translateY(-60px) scale(0.8);
                opacity: 0;
            }
        }

        .gem-animation {
            position: fixed;
            font-size: 3em;
            pointer-events: none;
            z-index: 9999;
            animation: gemFloat 1.5s ease-out;
        }

        .shop-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .shop-tab {
            flex: 1;
            padding: 15px;
            background: #f5f5f5;
            border: none;
            border-bottom: 3px solid transparent;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .shop-tab:hover {
            background: #e8e8e8;
        }

        .shop-tab.active {
            background: white;
            border-bottom-color: #9c27b0;
            color: #9c27b0;
        }

        .shop-tab.gem-tab.active {
            border-bottom-color: #e91e63;
            color: #e91e63;
        }

        .shop-tab-content {
            display: none;
        }

        .shop-tab-content.active {
            display: block;
        }

        .gem-shop-item {
            background: linear-gradient(135deg, #f3e5f5 0%, #fce4ec 100%);
            padding: 25px;
            border-radius: 10px;
            border-left: 5px solid #e91e63;
        }

        .gem-shop-item h3 {
            color: #e91e63;
            margin-bottom: 10px;
            font-size: 1.4em;
        }

        .gem-price {
            font-weight: bold;
            font-size: 1.2em;
            color: #e91e63;
        }

        .gem-icon {
            font-size: 0.6em;
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd0 100%);
            border: 2px solid #e91e63;
            padding: 5px 10px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(233, 30, 99, 0.3);
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <h1>üçî EMMETT O'BRIEN SIMULATOR üçü<span id="upgradeIcons"></span></h1>
            <p>Welcome to McDonald's! Make orders, earn O'Brien Points!</p>
            <div id="loggedInStatus" class="logged-in-status">
                ‚úì Logged in as <span id="headerUsername"></span> - Progress auto-saved
            </div>
        </div>

        <div class="stats">
            <div class="stat-box">
                <div class="label">O'Brien Points</div>
                <div class="value" id="points">0</div>
            </div>
            <div class="stat-box">
                <div class="label">Orders Completed</div>
                <div class="value" id="orders">0</div>
            </div>
            <div class="stat-box" id="gemsStatBox" style="display: none;">
                <div class="label">üíé Gems</div>
                <div class="value" id="gems">0</div>
            </div>
        </div>

        <div id="botsSection" style="display: none;" class="bots-active">
            <h4>ü§ñ Active Bots:</h4>
            <div id="botsList"></div>
        </div>

        <div id="achievementsSection" style="display: none;" class="achievements-section">
            <h3>üèÜ Achievements</h3>
            <div class="badges" id="badgesContainer"></div>
        </div>

        <div class="order-area">
            <div id="orderDisplay"></div>
            <div class="button-area">
                <button class="make-button" id="makeButton" onclick="startMakingOrder()">
                    Start New Order
                </button>
                <button class="complete-button" id="completeButton" onclick="completeOrder()" disabled>
                    Complete Order
                </button>
            </div>
        </div>

        <div class="order-area" id="secondOrderArea" style="display: none;">
            <div id="orderDisplay2"></div>
            <div class="button-area">
                <button class="make-button" id="makeButton2" onclick="startMakingOrder2()">
                    Start New Order (1.5x Faster)
                </button>
                <button class="complete-button" id="completeButton2" onclick="completeOrder2()" disabled>
                    Complete Order
                </button>
            </div>
        </div>
    </div>

    <button class="shop-button" onclick="openShop()">üõí SHOP</button>
    <button class="account-button" onclick="openAccount()">üë§ ACCOUNT</button>
    <button class="leaderboard-button" onclick="openLeaderboard()">üèÜ LEADERBOARD</button>
    <button class="settings-button" onclick="openSettings()">‚öôÔ∏è SETTINGS</button>

    <!-- Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <h2>‚öôÔ∏è Settings</h2>
            
            <div class="settings-section">
                <div class="settings-item">
                    <div class="settings-item-label">
                        <h3>üéµ Background Music</h3>
                        <p>Toggle background music on/off</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="musicToggle" checked onchange="toggleMusic()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="settings-item">
                    <div class="settings-item-label">
                        <h3>üîä Sound Effects</h3>
                        <p>Toggle button click sounds</p>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="sfxToggle" checked onchange="toggleSFX()">
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <button class="close-button" onclick="closeSettings()">Close Settings</button>
        </div>
    </div>

    <div class="bill-of-rights-modal" id="billModal">
        <div class="bill-of-rights-content">
            <div class="congrats-message">
                <h3>üéâ CONGRATULATIONS! üéâ</h3>
                <p>You've earned 10 O'Brien Points!</p>
                <p>Here is the Bill of Rights...</p>
            </div>

            <h2>The Bill of Rights</h2>
            
            <div class="amendment">
                <h3>Amendment I</h3>
                <p>Congress shall make no law respecting an establishment of religion, or prohibiting the free exercise thereof; or abridging the freedom of speech, or of the press; or the right of the people peaceably to assemble, and to petition the Government for a redress of grievances.</p>
            </div>

            <div class="amendment">
                <h3>Amendment II</h3>
                <p>A well regulated Militia, being necessary to the security of a free State, the right of the people to keep and bear Arms, shall not be infringed.</p>
            </div>

            <div class="amendment">
                <h3>Amendment III</h3>
                <p>No Soldier shall, in time of peace be quartered in any house, without the consent of the Owner, nor in time of war, but in a manner to be prescribed by law.</p>
            </div>

            <div class="amendment">
                <h3>Amendment IV</h3>
                <p>The right of the people to be secure in their persons, houses, papers, and effects, against unreasonable searches and seizures, shall not be violated, and no Warrants shall issue, but upon probable cause, supported by Oath or affirmation, and particularly describing the place to be searched, and the persons or things to be seized.</p>
            </div>

            <div class="amendment">
                <h3>Amendment V</h3>
                <p>No person shall be held to answer for a capital, or otherwise infamous crime, unless on a presentment or indictment of a Grand Jury, except in cases arising in the land or naval forces, or in the Militia, when in actual service in time of War or public danger; nor shall any person be subject for the same offence to be twice put in jeopardy of life or limb; nor shall be compelled in any criminal case to be a witness against himself, nor be deprived of life, liberty, or property, without due process of law; nor shall private property be taken for public use, without just compensation.</p>
            </div>

            <div class="amendment">
                <h3>Amendment VI</h3>
                <p>In all criminal prosecutions, the accused shall enjoy the right to a speedy and public trial, by an impartial jury of the State and district wherein the crime shall have been committed, which district shall have been previously ascertained by law, and to be informed of the nature and cause of the accusation; to be confronted with the witnesses against him; to have compulsory process for obtaining witnesses in his favor, and to have the Assistance of Counsel for his defence.</p>
            </div>

            <div class="amendment">
                <h3>Amendment VII</h3>
                <p>In Suits at common law, where the value in controversy shall exceed twenty dollars, the right of trial by jury shall be preserved, and no fact tried by a jury, shall be otherwise re-examined in any Court of the United States, than according to the rules of the common law.</p>
            </div>

            <div class="amendment">
                <h3>Amendment VIII</h3>
                <p>Excessive bail shall not be required, nor excessive fines imposed, nor cruel and unusual punishments inflicted.</p>
            </div>

            <div class="amendment">
                <h3>Amendment IX</h3>
                <p>The enumeration in the Constitution, of certain rights, shall not be construed to deny or disparage others retained by the people.</p>
            </div>

            <div class="amendment">
                <h3>Amendment X</h3>
                <p>The powers not delegated to the United States by the Constitution, nor prohibited by it to the States, are reserved to the States respectively, or to the people.</p>
            </div>

            <button class="close-button" onclick="closeBillOfRights()">Close</button>
        </div>
    </div>

    <div class="shop-modal" id="shopModal">
        <div class="shop-content">
            <h2>üõí SHOP</h2>
            
            <div class="shop-tabs">
                <button class="shop-tab active" onclick="switchShopTab('regular')">Regular Shop</button>
                <button class="shop-tab gem-tab" id="gemShopTab" style="display: none;" onclick="switchShopTab('gem')">üíé Gem Shop <span class="gem-icon">üíé</span></button>
            </div>

            <div id="regularShop" class="shop-tab-content active">
                <div class="shop-items">
                    <div class="shop-item">
                        <h3>üìú The Bill Of Rights</h3>
                        <p>Multiplies your O'Brien points by 2 every time you complete an order! Price increases by 2x with each purchase.</p>
                        <div class="shop-item-footer">
                            <span class="price" id="borPrice">10 Points</span>
                            <div class="buy-buttons-container">
                                <button class="buy-button" onclick="buyBillOfRights()">Buy</button>
                                <button class="buy-max-button" onclick="buyMaxBillOfRights()">Buy Max</button>
                            </div>
                        </div>
                        <small style="color: #2196f3; display: block; margin-top: 10px; font-weight: bold; font-size: 1em;">Owned: <span id="borCount">0</span></small>
                    </div>

                    <div class="shop-item">
                        <h3>üìÉ The Declaration of Independence</h3>
                        <p>Hire Thomas Jefferson as a bot to automatically complete 1 order every 3 seconds! Grants you the "Founding Father" achievement badge.</p>
                        <div class="shop-item-footer">
                            <span class="price">200 Points</span>
                            <button class="buy-button" id="doiButton" onclick="buyDeclaration()">Buy</button>
                        </div>
                    </div>

                    <div class="shop-item">
                        <h3>üîä Steven Bradley</h3>
                        <p>Makes an annoying noise every 5 seconds, BUT multiplies all your orders completed by 2! One-time purchase only.</p>
                        <div class="shop-item-footer">
                            <span class="price">1000 Points</span>
                            <button class="buy-button" id="stevenButton" onclick="buySteven()">Buy</button>
                        </div>
                    </div>

                    <div class="shop-item">
                        <h3>üèÖ Noah Roland Badge</h3>
                        <p>Unlock the prestigious Noah Roland achievement badge! Requires 50 orders completed. One-time purchase only.</p>
                        <div class="shop-item-footer">
                            <span class="price">50 Orders</span>
                            <button class="buy-button" id="noahButton" onclick="buyNoah()">Buy</button>
                        </div>
                    </div>

                    <div class="shop-item">
                        <h3>üìÑ Articles of Confederation</h3>
                        <p>Multiply your O'Brien points per order by 125%! Price increases by 10K with each purchase.</p>
                        <div class="shop-item-footer">
                            <span class="price" id="articlesPrice">10K Points</span>
                            <div class="buy-buttons-container">
                                <button class="buy-button" onclick="buyArticles()">Buy</button>
                                <button class="buy-max-button" onclick="buyMaxArticles()">Buy Max</button>
                            </div>
                        </div>
                        <small style="color: #2196f3; display: block; margin-top: 10px; font-weight: bold; font-size: 1em;">Owned: <span id="articlesCount">0</span></small>
                    </div>

                    <div class="shop-item">
                        <h3>üìÆ Stamp Act</h3>
                        <p>Adds a 110% boost to O'Brien point gain per order! Stack this upgrade for massive point bonuses. Price increases by 2x with each purchase.</p>
                        <div class="shop-item-footer">
                            <span class="price" id="stampActPrice">50K Points</span>
                            <div class="buy-buttons-container">
                                <button class="buy-button" onclick="buyStampAct()">Buy</button>
                                <button class="buy-max-button" onclick="buyMaxStampAct()">Buy Max</button>
                            </div>
                        </div>
                        <small style="color: #2196f3; display: block; margin-top: 10px; font-weight: bold; font-size: 1em;">Owned: <span id="stampActCount">0</span></small>
                    </div>

                    <div class="shop-item">
                        <h3>ü™ñ World War I</h3>
                        <p>Adds 100 flat O'Brien points to every order completed! Stack this upgrade for guaranteed bonus points. Price increases by 1.5x with each purchase.</p>
                        <div class="shop-item-footer">
                            <span class="price" id="ww1Price">2K Points</span>
                            <div class="buy-buttons-container">
                                <button class="buy-button" onclick="buyWW1()">Buy</button>
                                <button class="buy-max-button" onclick="buyMaxWW1()">Buy Max</button>
                            </div>
                        </div>
                        <small style="color: #2196f3; display: block; margin-top: 10px; font-weight: bold; font-size: 1em;">Owned: <span id="ww1Count">0</span></small>
                    </div>

                    <div class="shop-item">
                        <h3>üéÆ Bloon Tower Defense 1</h3>
                        <p>Unlock gems! Gain a 5% chance to earn a gem with every order completed. One-time purchase only.</p>
                        <div class="shop-item-footer">
                            <span class="price">100K Points</span>
                            <button class="buy-button" id="btd1Button" onclick="buyBTD1()">Buy</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="gemShop" class="shop-tab-content">
                <div class="shop-items">
                    <div class="gem-shop-item">
                        <h3>üçó Franks KFC</h3>
                        <p>Adds +1 gem whenever you earn a gem! Stack this upgrade to earn even more gems per order. Price increases by 1.8x with each purchase.</p>
                        <div class="shop-item-footer">
                            <span class="gem-price" id="franksPrice">5 Gems</span>
                            <button class="buy-button" onclick="buyFranks()">Buy</button>
                        </div>
                        <small style="color: #9c27b0; display: block; margin-top: 10px; font-weight: bold; font-size: 1em;">Owned: <span id="franksCount">0</span></small>
                    </div>

                    <div class="gem-shop-item">
                        <h3>üòé Kevins Shiny Bald Head</h3>
                        <p>Adds a second order starter below the first one! Orders started at this location complete 1.5x faster. One-time purchase only.</p>
                        <div class="shop-item-footer">
                            <span class="gem-price">50 Gems</span>
                            <button class="buy-button" id="kevinButton" onclick="buyKevin()">Buy</button>
                        </div>
                    </div>
                </div>
            </div>

            <button class="close-button" onclick="closeShop()">Close Shop</button>
        </div>
    </div>

    <div class="account-modal" id="accountModal">
        <div class="account-content">
            <h2>üë§ Account</h2>
            
            <!-- Login/Signup View -->
            <div id="authView" class="auth-view active">
                <div class="auth-tabs">
                    <button class="tab-button active" onclick="switchTab('login')">Login</button>
                    <button class="tab-button" onclick="switchTab('signup')">Sign Up</button>
                </div>

                <div id="errorMessage" class="error-message"></div>
                <div id="successMessage" class="success-message"></div>

                <!-- Login Form -->
                <form id="loginForm" class="auth-form active" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button type="submit" class="submit-button">Login</button>
                </form>

                <!-- Signup Form -->
                <form id="signupForm" class="auth-form" onsubmit="handleSignup(event)">
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="signupUsername" required minlength="3">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" required minlength="4">
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="signupPasswordConfirm" required>
                    </div>
                    <button type="submit" class="submit-button">Create Account</button>
                </form>

                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                    <p style="text-align: center; color: #666; margin-bottom: 10px; font-size: 0.9em;">Have save data from another device?</p>
                    <button onclick="document.getElementById('importFileInput').click()" style="width: 100%; padding: 12px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em;">
                        üì§ Import Save Data
                    </button>
                </div>

                <button class="close-button" onclick="closeAccount()">Close</button>
            </div>

            <!-- Logged In View -->
            <div id="loggedInView" class="logged-in-view">
                <div class="profile-header">
                    <h3>üë§ Profile</h3>
                    <div class="username" id="currentUsername"></div>
                    <button onclick="openUsernameChange()" style="margin-top: 10px; padding: 8px 15px; background: #2196f3; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 0.9em; font-weight: bold;">
                        ‚úèÔ∏è Change Username
                    </button>
                    <div class="user-title-display" id="userTitleDisplay" onclick="openTitleSelector()">Click to change title</div>
                    <div id="breckenBadge" style="display: none;" class="brecken-badge">‚≠ê CREATOR - 10x Point Bonus!</div>
                    <div class="member-since" id="memberSince">Member since: ...</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">O'Brien Points</div>
                        <div class="stat-value" id="userPoints">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Orders Completed</div>
                        <div class="stat-value" id="userOrders">0</div>
                    </div>
                    <div class="stat-card" id="userGemsCard" style="display: none;">
                        <div class="stat-label">üíé Gems</div>
                        <div class="stat-value" id="userGems">0</div>
                    </div>
                </div>

                <div class="profile-section">
                    <h4>‚ö° Active Multipliers</h4>
                    <div class="multipliers-display">
                        <div class="multiplier-box">
                            <div class="mult-label">Point Multiplier</div>
                            <div class="mult-value" id="userPointMult">1x</div>
                        </div>
                        <div class="multiplier-box">
                            <div class="mult-label">Order Multiplier</div>
                            <div class="mult-value" id="userOrderMult">1x</div>
                        </div>
                    </div>
                </div>

                <div class="profile-section">
                    <h4>üõí Shop Items Owned</h4>
                    <div class="shop-items-owned" id="ownedItemsList">
                        <p style="color: #999; text-align: center;">No items purchased yet</p>
                    </div>
                </div>

                <div class="profile-section" id="achievementsProfile" style="display: none;">
                    <h4>üèÜ Achievements</h4>
                    <div id="profileBadges"></div>
                </div>

                <div class="profile-section">
                    <h4>üíæ Save Information</h4>
                    <p style="color: #666; margin-bottom: 10px;">Last saved: <span id="lastSaveTime">Never</span></p>
                    <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">‚úì Your progress is automatically saved every 10 seconds and after each action</p>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="exportSaveData()" style="flex: 1; padding: 10px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            üì• Export Save Data
                        </button>
                        <button onclick="document.getElementById('importFileInput').click()" style="flex: 1; padding: 10px; background: #2196f3; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            üì§ Import Save Data
                        </button>
                    </div>
                    <input type="file" id="importFileInput" accept=".json" style="display: none;" onchange="importSaveData(event)">
                    <div style="background: #e3f2fd; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 3px solid #2196f3;">
                        <p style="color: #1976d2; font-size: 0.85em; margin: 0; line-height: 1.4;">
                            <strong>üí° Cross-Platform Saves:</strong> Export downloads a .json file. Transfer this file to another device and import it to continue your progress anywhere!
                        </p>
                    </div>
                </div>

                <!-- Admin Panel (Only visible to Brecken) -->
                <div class="profile-section" id="adminPanel" style="display: none;">
                    <h4 style="color: #c8102e;">üîí ADMIN PANEL</h4>
                    <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #c8102e; margin-bottom: 15px;">
                        <p style="color: #856404; margin: 0; font-size: 0.9em;">
                            <strong>‚ö†Ô∏è Admin Access:</strong> You have special privileges as the creator of this game.
                        </p>
                    </div>
                    
                    <div style="background: #f8f8f8; padding: 15px; border-radius: 8px;">
                        <h5 style="margin-bottom: 10px; color: #333;">Reset User Points</h5>
                        <p style="color: #666; font-size: 0.9em; margin-bottom: 10px;">Enter a username to reset their points to 0:</p>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" id="adminResetUsername" placeholder="Username..." 
                                style="flex: 1; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1em;">
                            <button onclick="adminResetUserPoints()" 
                                style="padding: 10px 20px; background: #c8102e; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                üóëÔ∏è Reset Points
                            </button>
                        </div>
                    </div>
                </div>

                <button class="logout-button" onclick="handleLogout()">Logout</button>
                <button class="close-button" onclick="closeAccount()">Close</button>
            </div>
        </div>
    </div>

    <div class="title-modal" id="titleModal">
        <div class="title-content">
            <h2>üéñÔ∏è Select Your Title</h2>
            <div class="titles-list" id="titlesList"></div>
            <button class="close-button" onclick="closeTitleSelector()">Close</button>
        </div>
    </div>

    <div class="title-modal" id="usernameChangeModal">
        <div class="title-content">
            <h2>‚úèÔ∏è Change Username</h2>
            <div style="margin-bottom: 20px;">
                <p style="color: #666; margin-bottom: 15px;">Current username: <strong id="currentUsernameDisplay"></strong></p>
                <p style="color: #666; font-size: 0.9em; margin-bottom: 20px;">Choose a new username. Your progress and stats will be preserved.</p>
                
                <div id="usernameChangeError" class="error-message"></div>
                <div id="usernameChangeSuccess" class="success-message"></div>
                
                <div class="form-group">
                    <label>New Username</label>
                    <input type="text" id="newUsername" placeholder="Enter new username" minlength="3" maxlength="20" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                    <small style="color: #999; display: block; margin-top: 5px;">3-20 characters. Letters, numbers, underscores, and hyphens only.</small>
                </div>
                
                <div class="form-group">
                    <label>Confirm Password</label>
                    <input type="password" id="usernameChangePassword" placeholder="Enter your password" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                    <small style="color: #999; display: block; margin-top: 5px;">Verify your password to change username</small>
                </div>
                
                <button onclick="changeUsername()" style="width: 100%; padding: 15px; background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white; border: none; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; margin-top: 10px;">
                    Change Username
                </button>
            </div>
            <button class="close-button" onclick="closeUsernameChange()">Cancel</button>
        </div>
    </div>

    <div class="leaderboard-modal" id="leaderboardModal">
        <div class="leaderboard-content">
            <h2>üèÜ Leaderboard</h2>
            <p class="leaderboard-subtitle">Top 50 Players by Orders Completed</p>
            <div id="leaderboardStatus" style="text-align: center; margin-bottom: 15px; padding: 10px; border-radius: 8px; font-size: 0.9em;"></div>
            <table class="leaderboard-table">
                <thead>
                    <tr>
                        <th>Rank</th>
                        <th>Player</th>
                        <th>Orders Completed</th>
                        <th>O'Brien Points</th>
                        <th>üíé Gems</th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                    <!-- Leaderboard rows will be inserted here -->
                </tbody>
            </table>
            <button class="close-button" onclick="closeLeaderboard()">Close</button>
        </div>
    </div>

    <script>
        // ==========================================
        // FIREBASE CONFIGURATION
        // ==========================================
        // Firebase configuration for Emmett O'Brien Game
        // This connects to your Firebase Realtime Database for the global leaderboard
        
        const firebaseConfig = {
            apiKey: "AIzaSyBuTPp6gjPtvM4HgOypHOxqDokAPoNp-z4",
            authDomain: "emmett-obrien-game.firebaseapp.com",
            databaseURL: "https://emmett-obrien-game-default-rtdb.firebaseio.com",
            projectId: "emmett-obrien-game",
            storageBucket: "emmett-obrien-game.firebasestorage.app",
            messagingSenderId: "38645692528",
            appId: "1:38645692528:web:8637f1ab6bd192b9f31cb5",
            measurementId: "G-Y9TWLM159M"
        };
        
        // Initialize Firebase
        let database = null;
        let firebaseEnabled = false;
        
        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            firebaseEnabled = true;
            console.log("‚úÖ Firebase connected - Global leaderboard enabled!");
            console.log("üåê All players worldwide can now compete together!");
        } catch (error) {
            console.error("‚ùå Firebase initialization error:", error);
            console.log("‚ÑπÔ∏è Falling back to local leaderboard");
        }
        
        // Number formatting function
        function formatNumber(num) {
            // Handle scientific notation for extremely large numbers (> 10^306)
            if (num >= 1e306) {
                const exponent = Math.floor(Math.log10(num));
                const mantissa = num / Math.pow(10, exponent);
                return mantissa.toFixed(2) + 'e' + exponent;
            }
            
            // Define number abbreviations (short scale)
            const abbreviations = [
                { value: 1e303, symbol: 'Cen' },      // Centillion
                { value: 1e300, symbol: 'NoVg' },     // Novemnonagintillion
                { value: 1e297, symbol: 'OcVg' },     // Octononagintillion
                { value: 1e294, symbol: 'SpVg' },     // Septennonagintillion
                { value: 1e291, symbol: 'SxVg' },     // Sexnonagintillion
                { value: 1e288, symbol: 'QiVg' },     // Quinnonagintillion
                { value: 1e285, symbol: 'QaVg' },     // Quattuornonagintillion
                { value: 1e282, symbol: 'TrVg' },     // Trenonagintillion
                { value: 1e279, symbol: 'DuVg' },     // Duononagintillion
                { value: 1e276, symbol: 'UnVg' },     // Unnonagintillion
                { value: 1e273, symbol: 'Vg' },       // Vigintillion
                { value: 1e270, symbol: 'NoTg' },     // Novemoctogintillion
                { value: 1e267, symbol: 'OcTg' },     // Octooctogintillion
                { value: 1e264, symbol: 'SpTg' },     // Septemoctogintillion
                { value: 1e261, symbol: 'SxTg' },     // Sexoctogintillion
                { value: 1e258, symbol: 'QiTg' },     // Quinoctogintillion
                { value: 1e255, symbol: 'QaTg' },     // Quattuoroctogintillion
                { value: 1e252, symbol: 'TrTg' },     // Tresoctogintillion
                { value: 1e249, symbol: 'DuTg' },     // Duooctogintillion
                { value: 1e246, symbol: 'UnTg' },     // Unoctogintillion
                { value: 1e243, symbol: 'Og' },       // Octogintillion
                { value: 1e240, symbol: 'NoSg' },     // Novemseptuagintillion
                { value: 1e237, symbol: 'OcSg' },     // Octoseptuagintillion
                { value: 1e234, symbol: 'SpSg' },     // Septemseptuagintillion
                { value: 1e231, symbol: 'SxSg' },     // Sexseptuagintillion
                { value: 1e228, symbol: 'QiSg' },     // Quinseptuagintillion
                { value: 1e225, symbol: 'QaSg' },     // Quattuorseptuagintillion
                { value: 1e222, symbol: 'TrSg' },     // Treseptuagintillion
                { value: 1e219, symbol: 'DuSg' },     // Duoseptuagintillion
                { value: 1e216, symbol: 'UnSg' },     // Unseptuagintillion
                { value: 1e213, symbol: 'Sg' },       // Septuagintillion
                { value: 1e210, symbol: 'NoSx' },     // Novemsexagintillion
                { value: 1e207, symbol: 'OcSx' },     // Octosexagintillion
                { value: 1e204, symbol: 'SpSx' },     // Septemsexagintillion
                { value: 1e201, symbol: 'SxSx' },     // Sexsexagintillion
                { value: 1e198, symbol: 'QiSx' },     // Quinsexagintillion
                { value: 1e195, symbol: 'QaSx' },     // Quattuorsexagintillion
                { value: 1e192, symbol: 'TrSx' },     // Tresexagintillion
                { value: 1e189, symbol: 'DuSx' },     // Duosexagintillion
                { value: 1e186, symbol: 'UnSx' },     // Unsexagintillion
                { value: 1e183, symbol: 'Sx' },       // Sexagintillion
                { value: 1e180, symbol: 'NoQg' },     // Novemquinquagintillion
                { value: 1e177, symbol: 'OcQg' },     // Octoquinquagintillion
                { value: 1e174, symbol: 'SpQg' },     // Septenquinquagintillion
                { value: 1e171, symbol: 'SxQg' },     // Sexquinquagintillion
                { value: 1e168, symbol: 'QiQg' },     // Quinquinquagintillion
                { value: 1e165, symbol: 'QaQg' },     // Quattuorquinquagintillion
                { value: 1e162, symbol: 'TrQg' },     // Tresquinquagintillion
                { value: 1e159, symbol: 'DuQg' },     // Duoquinquagintillion
                { value: 1e156, symbol: 'UnQg' },     // Unquinquagintillion
                { value: 1e153, symbol: 'Qg' },       // Quinquagintillion
                { value: 1e150, symbol: 'NoQd' },     // Novemquadragintillion
                { value: 1e147, symbol: 'OcQd' },     // Octoquadragintillion
                { value: 1e144, symbol: 'SpQd' },     // Septenquadragintillion
                { value: 1e141, symbol: 'SxQd' },     // Sexquadragintillion
                { value: 1e138, symbol: 'QiQd' },     // Quinquadragintillion
                { value: 1e135, symbol: 'QaQd' },     // Quattuorquadragintillion
                { value: 1e132, symbol: 'TrQd' },     // Tresquadragintillion
                { value: 1e129, symbol: 'DuQd' },     // Duoquadragintillion
                { value: 1e126, symbol: 'UnQd' },     // Unquadragintillion
                { value: 1e123, symbol: 'Qd' },       // Quadragintillion
                { value: 1e120, symbol: 'NoTr' },     // Novemtrigintillion
                { value: 1e117, symbol: 'OcTr' },     // Octotrigintillion
                { value: 1e114, symbol: 'SpTr' },     // Septentrigintillion
                { value: 1e111, symbol: 'SxTr' },     // Sextrigintillion
                { value: 1e108, symbol: 'QiTr' },     // Quintrigintillion
                { value: 1e105, symbol: 'QaTr' },     // Quattuortrigintillion
                { value: 1e102, symbol: 'TrTr' },     // Trestrigintillion
                { value: 1e99, symbol: 'DuTr' },      // Duotrigintillion
                { value: 1e96, symbol: 'UnTr' },      // Untrigintillion
                { value: 1e93, symbol: 'Tr' },        // Trigintillion
                { value: 1e90, symbol: 'NoVi' },      // Novemvigintillion
                { value: 1e87, symbol: 'OcVi' },      // Octovigintillion
                { value: 1e84, symbol: 'SpVi' },      // Septenvigintillion
                { value: 1e81, symbol: 'SxVi' },      // Sexvigintillion
                { value: 1e78, symbol: 'QiVi' },      // Quinvigintillion
                { value: 1e75, symbol: 'QaVi' },      // Quattuorvigintillion
                { value: 1e72, symbol: 'TrVi' },      // Tresvigintillion
                { value: 1e69, symbol: 'DuVi' },      // Duovigintillion
                { value: 1e66, symbol: 'UnVi' },      // Unvigintillion
                { value: 1e63, symbol: 'Vi' },        // Vigintillion
                { value: 1e60, symbol: 'Nd' },        // Novemdecillion
                { value: 1e57, symbol: 'Od' },        // Octodecillion
                { value: 1e54, symbol: 'Spd' },       // Septendecillion
                { value: 1e51, symbol: 'Sxd' },       // Sexdecillion
                { value: 1e48, symbol: 'Qid' },       // Quindecillion
                { value: 1e45, symbol: 'Qad' },       // Quattuordecillion
                { value: 1e42, symbol: 'Trd' },       // Tredecillion
                { value: 1e39, symbol: 'Dd' },        // Duodecillion
                { value: 1e36, symbol: 'Ud' },        // Undecillion
                { value: 1e33, symbol: 'Dc' },        // Decillion
                { value: 1e30, symbol: 'No' },        // Nonillion
                { value: 1e27, symbol: 'Oc' },        // Octillion
                { value: 1e24, symbol: 'Sp' },        // Septillion
                { value: 1e21, symbol: 'Sx' },        // Sextillion
                { value: 1e18, symbol: 'Qi' },        // Quintillion
                { value: 1e15, symbol: 'Qa' },        // Quadrillion
                { value: 1e12, symbol: 'T' },         // Trillion
                { value: 1e9, symbol: 'B' },          // Billion
                { value: 1e6, symbol: 'M' },          // Million
                { value: 1e3, symbol: 'K' }           // Thousand
            ];
            
            // Find appropriate abbreviation
            for (let i = 0; i < abbreviations.length; i++) {
                if (num >= abbreviations[i].value) {
                    const formatted = (num / abbreviations[i].value).toFixed(1).replace(/\.0$/, '');
                    return formatted + abbreviations[i].symbol;
                }
            }
            
            // Return as-is for numbers less than 1000
            return Math.floor(num).toString();
        }

        let points = 0;
        let ordersCompleted = 0;
        let currentOrder = null;
        let progress = 0;
        let progressInterval = null;
        let hasShownBillOfRights = false;
        let gems = 0;

        // Shop items
        let billOfRightsOwned = 0;
        let billOfRightsPrice = 10;
        let pointMultiplier = 1;
        let billOfRightsBadgeEarned = false;
        
        let declarationOwned = false;
        let declarationBotInterval = null;
        
        let articlesOwned = 0;
        let articlesPrice = 10000;
        let articlesMultiplier = 1;
        
        let stampActOwned = 0;
        let stampActPrice = 50000;
        let stampActBoost = 0; // Total percentage boost (110% per purchase)
        
        let ww1Owned = 0;
        let ww1Price = 2000;
        let ww1PointsPerOrder = 0; // Total flat points (100 per purchase)
        
        let btd1Owned = false;
        let gemChance = 0;
        
        let stevenBradleyOwned = false;
        let stevenInterval = null;
        
        let noahRolandOwned = false;
        
        let orderMultiplier = 1;

        // Gem shop items
        let franksKFCOwned = 0;
        let franksKFCPrice = 5;
        let gemMultiplier = 1;
        let franksKFCBadgeEarned = false;

        let kevinBaldHeadOwned = false;
        let kevinBaldHeadBadgeEarned = false;

        // Second order area
        let currentOrder2 = null;
        let progress2 = 0;
        let progressInterval2 = null;

        // ==========================================
        // AUDIO SYSTEM
        // ==========================================
        
        // Audio settings
        let musicEnabled = true;
        let sfxEnabled = true;
        
        // Background music
        let backgroundMusic = null;
        
        // Initialize audio system
        function initAudioSystem() {
            // Load settings from localStorage
            const savedMusicSetting = localStorage.getItem('musicEnabled');
            const savedSFXSetting = localStorage.getItem('sfxEnabled');
            
            if (savedMusicSetting !== null) {
                musicEnabled = savedMusicSetting === 'true';
            }
            if (savedSFXSetting !== null) {
                sfxEnabled = savedSFXSetting === 'true';
            }
            
            // Update toggle switches
            document.getElementById('musicToggle').checked = musicEnabled;
            document.getElementById('sfxToggle').checked = sfxEnabled;
            
            // Initialize background music
            // TODO: Upload your background music mp3 file and update the path below
            backgroundMusic = new Audio('background-music.mp3'); // UPDATE THIS WITH YOUR MP3 FILENAME
            backgroundMusic.loop = true;
            backgroundMusic.volume = 0.4; // 40% volume
            
            // Start background music if enabled
            if (musicEnabled) {
                // Auto-play might be blocked by browser, so we handle the promise
                backgroundMusic.play().catch(err => {
                    console.log('Auto-play prevented. Music will start on first user interaction.');
                });
            }
            
            // Add click event listeners to all buttons
            addButtonSoundEffects();
        }
        
        // Add sound effects to all buttons
        function addButtonSoundEffects() {
            // Get all buttons
            const buttons = document.querySelectorAll('button');
            
            buttons.forEach(button => {
                button.addEventListener('click', playButtonSound);
            });
        }
        
        // Play button click sound
        function playButtonSound() {
            if (!sfxEnabled) return;
            
            // Create a simple click sound using Web Audio API
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // Click frequency
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.1);
        }
        
        // Settings modal functions
        function openSettings() {
            document.getElementById('settingsModal').style.display = 'block';
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        function toggleMusic() {
            musicEnabled = document.getElementById('musicToggle').checked;
            localStorage.setItem('musicEnabled', musicEnabled);
            
            if (musicEnabled) {
                backgroundMusic.play().catch(err => console.log('Music play failed:', err));
            } else {
                backgroundMusic.pause();
            }
        }
        
        function toggleSFX() {
            sfxEnabled = document.getElementById('sfxToggle').checked;
            localStorage.setItem('sfxEnabled', sfxEnabled);
        }
        
        // Close settings modal when clicking outside
        window.addEventListener('click', function(event) {
            const settingsModal = document.getElementById('settingsModal');
            if (event.target === settingsModal) {
                closeSettings();
            }
        });

        // Account system
        let currentUser = null;
        let autoSaveInterval = null;
        let selectedTitle = null;

        // Username validation - filter inappropriate words
        const bannedWords = [
            // Slurs and offensive terms
            'nigger', 'nigga', 'nig', 'negro', 'coon', 'spook', 'chink', 'gook', 'jap', 'kike', 
            'wetback', 'beaner', 'spic', 'towelhead', 'raghead', 'sandnigger', 'paki', 'muzzie',
            'faggot', 'fag', 'dyke', 'tranny', 'shemale', 'homo',
            'retard', 'retarded', 'mongoloid', 'downie',
            // Extreme profanity
            'cunt', 'bitch', 'whore', 'slut', 'pussy',
            // Hateful terms
            'nazi', 'hitler', 'kkk', 'swastika',
            // Sexual/explicit
            'porn', 'sex', 'penis', 'dick', 'cock', 'vagina', 'fuck', 'shit', 'ass',
            // Add variations with numbers
            'n1gger', 'n1gga', 'f4ggot', 'fvck', 'sh1t', 'b1tch'
        ];

        function validateUsername(username) {
            const lowerUsername = username.toLowerCase().replace(/[^a-z0-9]/g, '');
            
            // Check length
            if (username.length < 3 || username.length > 20) {
                return { valid: false, message: 'Username must be 3-20 characters long.' };
            }
            
            // Check for banned words
            for (const word of bannedWords) {
                if (lowerUsername.includes(word)) {
                    return { valid: false, message: 'Username contains inappropriate language. Please choose a different username.' };
                }
            }
            
            // Check for only numbers
            if (/^\d+$/.test(username)) {
                return { valid: false, message: 'Username cannot be only numbers.' };
            }
            
            // Check for valid characters (letters, numbers, underscore, hyphen)
            if (!/^[a-zA-Z0-9_-]+$/.test(username)) {
                return { valid: false, message: 'Username can only contain letters, numbers, underscores, and hyphens.' };
            }
            
            return { valid: true };
        }

        // Title system
        const titles = [
            { id: 'none', name: 'No Title', requirement: 0, requirementText: 'Default' },
            { id: 'beginner', name: 'Beginner O\'Brien', requirement: 10, requirementText: 'Complete 10 orders' },
            { id: 'intermediate', name: 'Intermediate O\'Brien', requirement: 50, requirementText: 'Complete 50 orders' },
            { id: 'advanced', name: 'Advanced O\'Brien', requirement: 250, requirementText: 'Complete 250 orders' },
            { id: 'creator', name: 'Creator', requirement: -1, requirementText: 'Special (Brecken only)' }
        ];

        // Initialize on page load
        window.onload = function() {
            checkLoggedInUser();
            initAudioSystem();
        };

        const menuItems = [
            'Big Mac', 'Quarter Pounder', 'McChicken', 'Filet-O-Fish',
            'Large Fries', 'Medium Fries', 'Small Fries',
            'Chicken McNuggets (10pc)', 'Chicken McNuggets (6pc)',
            'McFlurry', 'Apple Pie', 'Cheeseburger', 'Happy Meal',
            'Coca-Cola', 'Sprite', 'Orange Juice', 'Coffee', 'Iced Coffee'
        ];

        function generateRandomOrder() {
            const numItems = Math.floor(Math.random() * 4) + 2; // 2-5 items
            const items = [];
            for (let i = 0; i < numItems; i++) {
                const item = menuItems[Math.floor(Math.random() * menuItems.length)];
                items.push(item);
            }
            return items;
        }

        function startMakingOrder() {
            if (currentOrder) return;
            
            // Ensure background music is playing (in case auto-play was blocked)
            if (musicEnabled && backgroundMusic && backgroundMusic.paused) {
                backgroundMusic.play().catch(err => console.log('Music play failed:', err));
            }

            currentOrder = generateRandomOrder();
            progress = 0;
            
            document.getElementById('makeButton').disabled = true;
            document.getElementById('completeButton').disabled = true;

            displayOrder();
            startProgress();
        }

        function displayOrder() {
            const orderDisplay = document.getElementById('orderDisplay');
            orderDisplay.innerHTML = `
                <div class="current-order">
                    <h3>üìã Current Order:</h3>
                    <ul class="order-items">
                        ${currentOrder.map(item => `<li><span>${item}</span><span>‚úì</span></li>`).join('')}
                    </ul>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill" style="width: 0%">
                            Making... 0%
                        </div>
                    </div>
                </div>
            `;
        }

        function startProgress() {
            progressInterval = setInterval(() => {
                progress += 2;
                const progressFill = document.getElementById('progressFill');
                progressFill.style.width = progress + '%';
                progressFill.textContent = `Making... ${progress}%`;

                if (progress >= 100) {
                    clearInterval(progressInterval);
                    progressFill.textContent = 'Ready!';
                    document.getElementById('completeButton').disabled = false;
                }
            }, 50);
        }

        function completeOrder() {
            if (!currentOrder) return;

            let ordersToAdd = 1 * orderMultiplier;
            ordersCompleted += ordersToAdd;
            
            let pointsToAdd = 1 * pointMultiplier * articlesMultiplier;
            
            // Apply Stamp Act boost (percentage)
            if (stampActBoost > 0) {
                pointsToAdd *= (1 + stampActBoost / 100);
            }
            
            // Apply World War I flat bonus
            pointsToAdd += ww1PointsPerOrder;
            
            // Apply Brecken bonus (10x points)
            if (currentUser && currentUser.toLowerCase() === 'brecken') {
                pointsToAdd *= 10;
            }
            
            points += pointsToAdd;
            
            // Gem chance if BTD1 owned
            let gemEarned = false;
            let gemsEarnedAmount = 0;
            if (btd1Owned && Math.random() < 0.05) {
                gemsEarnedAmount = 1 * gemMultiplier;
                gems += gemsEarnedAmount;
                gemEarned = true;
                document.getElementById('gems').textContent = formatNumber(gems);
                
                // Show gem animation
                showGemAnimation();
                
                // Show gem shop tab if this is the first gem
                if (gems >= 1) {
                    document.getElementById('gemShopTab').style.display = 'block';
                }
            }
            
            document.getElementById('orders').textContent = formatNumber(ordersCompleted);
            document.getElementById('points').textContent = formatNumber(points);
            
            // Add pulse animation
            document.getElementById('points').classList.add('pulse');
            setTimeout(() => {
                document.getElementById('points').classList.remove('pulse');
            }, 500);

            currentOrder = null;
            let bonusText = (currentUser && currentUser.toLowerCase() === 'brecken') ? ' (10x Brecken Bonus!)' : '';
            let gemText = gemEarned ? `<p style="color: #9c27b0; font-weight: bold;">üíé +${gemsEarnedAmount} Gem${gemsEarnedAmount > 1 ? 's' : ''} earned!</p>` : '';
            document.getElementById('orderDisplay').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #4caf50; font-size: 1.5em; margin-bottom: 10px;">‚úÖ Order Complete!</h3>
                    <p style="color: #666;">+${formatNumber(pointsToAdd)} O'Brien Point${pointsToAdd > 1 ? 's' : ''} earned!${bonusText}</p>
                    <p style="color: #666;">+${ordersToAdd} Order${ordersToAdd > 1 ? 's' : ''} completed!</p>
                    ${gemText}
                </div>
            `;

            document.getElementById('completeButton').disabled = true;
            document.getElementById('makeButton').disabled = false;

            if (points >= 10 && !hasShownBillOfRights) {
                hasShownBillOfRights = true;
                setTimeout(showBillOfRights, 1000);
            }

            // Auto-save if user is logged in
            if (currentUser) {
                saveProgress();
                updateUserStats();
            }
        }

        function showBillOfRights() {
            const modal = document.getElementById('billModal');
            modal.style.display = 'block';
            
            // Read the Bill of Rights using text-to-speech
            if ('speechSynthesis' in window) {
                const text = getBillOfRightsText();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 1;
                window.speechSynthesis.speak(utterance);
            }
        }

        function getBillOfRightsText() {
            return `
                Congratulations! You have earned 10 O'Brien Points! 
                Here is the Bill of Rights of the United States Constitution.
                
                Amendment 1: Congress shall make no law respecting an establishment of religion, or prohibiting the free exercise thereof; or abridging the freedom of speech, or of the press; or the right of the people peaceably to assemble, and to petition the Government for a redress of grievances.
                
                Amendment 2: A well regulated Militia, being necessary to the security of a free State, the right of the people to keep and bear Arms, shall not be infringed.
                
                Amendment 3: No Soldier shall, in time of peace be quartered in any house, without the consent of the Owner, nor in time of war, but in a manner to be prescribed by law.
                
                Amendment 4: The right of the people to be secure in their persons, houses, papers, and effects, against unreasonable searches and seizures, shall not be violated, and no Warrants shall issue, but upon probable cause, supported by Oath or affirmation, and particularly describing the place to be searched, and the persons or things to be seized.
                
                Amendment 5: No person shall be held to answer for a capital, or otherwise infamous crime, unless on a presentment or indictment of a Grand Jury, except in cases arising in the land or naval forces, or in the Militia, when in actual service in time of War or public danger; nor shall any person be subject for the same offence to be twice put in jeopardy of life or limb; nor shall be compelled in any criminal case to be a witness against himself, nor be deprived of life, liberty, or property, without due process of law; nor shall private property be taken for public use, without just compensation.
                
                Amendment 6: In all criminal prosecutions, the accused shall enjoy the right to a speedy and public trial, by an impartial jury of the State and district wherein the crime shall have been committed, which district shall have been previously ascertained by law, and to be informed of the nature and cause of the accusation; to be confronted with the witnesses against him; to have compulsory process for obtaining witnesses in his favor, and to have the Assistance of Counsel for his defence.
                
                Amendment 7: In Suits at common law, where the value in controversy shall exceed twenty dollars, the right of trial by jury shall be preserved, and no fact tried by a jury, shall be otherwise re-examined in any Court of the United States, than according to the rules of the common law.
                
                Amendment 8: Excessive bail shall not be required, nor excessive fines imposed, nor cruel and unusual punishments inflicted.
                
                Amendment 9: The enumeration in the Constitution, of certain rights, shall not be construed to deny or disparage others retained by the people.
                
                Amendment 10: The powers not delegated to the United States by the Constitution, nor prohibited by it to the States, are reserved to the States respectively, or to the people.
            `;
        }

        function closeBillOfRights() {
            document.getElementById('billModal').style.display = 'none';
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
            }
        }

        // Shop Functions
        function openShop() {
            document.getElementById('shopModal').style.display = 'block';
            updateShopDisplay();
        }

        function closeShop() {
            document.getElementById('shopModal').style.display = 'none';
        }

        function updateShopDisplay() {
            document.getElementById('borPrice').textContent = formatNumber(billOfRightsPrice) + ' Points';
            document.getElementById('borCount').textContent = billOfRightsOwned;
            document.getElementById('articlesPrice').textContent = formatNumber(articlesPrice) + ' Points';
            document.getElementById('articlesCount').textContent = articlesOwned;
            document.getElementById('stampActPrice').textContent = formatNumber(stampActPrice) + ' Points';
            document.getElementById('stampActCount').textContent = stampActOwned;
            document.getElementById('ww1Price').textContent = formatNumber(ww1Price) + ' Points';
            document.getElementById('ww1Count').textContent = ww1Owned;
        }

        function updateUpgradeIcons() {
            const iconsContainer = document.getElementById('upgradeIcons');
            iconsContainer.innerHTML = '';
            
            if (billOfRightsOwned > 0) {
                const icon = document.createElement('span');
                icon.className = 'bor-icon';
                icon.textContent = `üìú x${billOfRightsOwned}`;
                iconsContainer.appendChild(icon);
            }
            
            if (articlesOwned > 0) {
                const icon = document.createElement('span');
                icon.className = 'bor-icon';
                icon.textContent = `üìÑ x${articlesOwned}`;
                iconsContainer.appendChild(icon);
            }
            
            if (stampActOwned > 0) {
                const icon = document.createElement('span');
                icon.className = 'bor-icon';
                icon.textContent = `üìÆ x${stampActOwned}`;
                iconsContainer.appendChild(icon);
            }
            
            if (ww1Owned > 0) {
                const icon = document.createElement('span');
                icon.className = 'bor-icon';
                icon.textContent = `ü™ñ x${ww1Owned}`;
                iconsContainer.appendChild(icon);
            }
        }
        
        // Keep old function name for compatibility
        function updateBORIcons() {
            updateUpgradeIcons();
        }

        function buyBillOfRights() {
            if (points >= billOfRightsPrice) {
                points -= billOfRightsPrice;
                billOfRightsOwned++;
                pointMultiplier *= 2;
                billOfRightsPrice = Math.floor(billOfRightsPrice * 2);
                
                // Award badge on first purchase
                if (!billOfRightsBadgeEarned) {
                    billOfRightsBadgeEarned = true;
                    addBillOfRightsBadge();
                }
                
                document.getElementById('points').textContent = points;
                updateShopDisplay();
                updateBORIcons();
                
                let message = `Bill of Rights purchased! Your point multiplier is now ${pointMultiplier}x!`;
                if (billOfRightsOwned === 1) {
                    message += '\n\nAchievement Unlocked: "Constitutional Scholar"!';
                }
                alert(message);
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function addBillOfRightsBadge() {
            const achievementsSection = document.getElementById('achievementsSection');
            const badgesContainer = document.getElementById('badgesContainer');
            
            achievementsSection.style.display = 'block';
            
            // Check if badge already exists
            if (document.getElementById('borBadge')) return;
            
            const badge = document.createElement('div');
            badge.id = 'borBadge';
            badge.className = 'badge';
            badge.innerHTML = `
                <span class="badge-icon">üìú</span>
                <span>Constitutional Scholar</span>
            `;
            badgesContainer.appendChild(badge);
        }

        function buyDeclaration() {
            if (declarationOwned) {
                alert('You already own the Declaration of Independence!');
                return;
            }
            
            if (points >= 200) {
                points -= 200;
                declarationOwned = true;
                
                document.getElementById('points').textContent = points;
                document.getElementById('doiButton').disabled = true;
                document.getElementById('doiButton').textContent = 'OWNED';
                
                // Start the bot
                startDeclarationBot();
                updateBotsDisplay();
                
                // Add badge
                addDeclarationBadge();
                
                alert('Thomas Jefferson hired! You now have a bot working for you and earned the "Founding Father" badge!');
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function startDeclarationBot() {
            declarationBotInterval = setInterval(() => {
                // Bot completes an order automatically
                let pointsToAdd = 1 * pointMultiplier * articlesMultiplier;
                
                // Apply Brecken bonus (10x points)
                if (currentUser && currentUser.toLowerCase() === 'brecken') {
                    pointsToAdd *= 10;
                }
                
                let ordersToAdd = 1 * orderMultiplier;
                
                points += pointsToAdd;
                ordersCompleted += ordersToAdd;
                
                // Gem chance if BTD1 owned
                if (btd1Owned && Math.random() < 0.05) {
                    let gemsToAdd = 1 * gemMultiplier;
                    gems += gemsToAdd;
                    document.getElementById('gems').textContent = formatNumber(gems);
                    
                    // Show gem shop tab if this is the first gem
                    if (gems >= 1) {
                        document.getElementById('gemShopTab').style.display = 'block';
                    }
                }
                
                document.getElementById('points').textContent = formatNumber(points);
                document.getElementById('orders').textContent = formatNumber(ordersCompleted);
                
                // Auto-save if user is logged in (but only save every 5 bot completions to reduce overhead)
                if (currentUser && ordersCompleted % 5 === 0) {
                    saveProgress();
                    updateUserStats();
                }
            }, 3000);
        }

        function addDeclarationBadge() {
            const achievementsSection = document.getElementById('achievementsSection');
            const badgesContainer = document.getElementById('badgesContainer');
            
            achievementsSection.style.display = 'block';
            
            // Check if badge already exists
            if (document.getElementById('declarationBadge')) return;
            
            const badge = document.createElement('div');
            badge.id = 'declarationBadge';
            badge.className = 'badge';
            badge.innerHTML = `
                <span class="badge-icon">üìÉ</span>
                <span>Founding Father</span>
            `;
            badgesContainer.appendChild(badge);
        }


        function updateBotsDisplay() {
            const botsSection = document.getElementById('botsSection');
            const botsList = document.getElementById('botsList');
            
            if (declarationOwned) {
                botsSection.style.display = 'block';
                botsList.innerHTML = `
                    <div class="bot-info">
                        <span>üìÉ</span> Thomas Jefferson Bot (1 order every 3 seconds)
                    </div>
                `;
            } else {
                botsSection.style.display = 'none';
            }
        }

        function buySteven() {
            if (stevenBradleyOwned) {
                alert('You already own Steven Bradley!');
                return;
            }
            
            if (points >= 1000) {
                points -= 1000;
                stevenBradleyOwned = true;
                orderMultiplier *= 2;
                
                document.getElementById('points').textContent = points;
                document.getElementById('stevenButton').disabled = true;
                document.getElementById('stevenButton').textContent = 'OWNED';
                
                // Start annoying sound
                startStevenSound();
                
                alert('Steven Bradley purchased! Your order completion multiplier is now 2x!\n(Warning: Annoying sound activated!)');
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function startStevenSound() {
            // TODO: Upload your mp3 file and update the path below
            // Place your mp3 file in the same directory as this HTML file
            const audioPath = 'your-sound-file.mp3'; // UPDATE THIS WITH YOUR MP3 FILENAME
            
            stevenInterval = setInterval(() => {
                const audio = new Audio(audioPath);
                audio.volume = 0.5; // Adjust volume (0.0 to 1.0)
                audio.play().catch(err => console.log('Audio play failed:', err));
            }, 5000); // Play every 5 seconds
        }

        function buyNoah() {
            if (noahRolandOwned) {
                alert('You already own the Noah Roland Badge!');
                return;
            }
            
            if (ordersCompleted >= 50) {
                noahRolandOwned = true;
                
                document.getElementById('noahButton').disabled = true;
                document.getElementById('noahButton').textContent = 'OWNED';
                
                // Add badge to achievements
                addNoahBadge();
                
                alert('Noah Roland Badge unlocked! Check your achievements!');
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                }
            } else {
                alert(`You need ${50 - ordersCompleted} more orders completed!`);
            }
        }

        function buyArticles() {
            if (points >= articlesPrice) {
                points -= articlesPrice;
                articlesOwned++;
                articlesMultiplier *= 1.25; // 125% multiplier
                
                // Every 10 purchases, multiply price by 10, otherwise add 10K
                if (articlesOwned % 10 === 0) {
                    articlesPrice = Math.floor(articlesPrice * 10);
                } else {
                    articlesPrice += 10000;
                }
                
                document.getElementById('points').textContent = formatNumber(points);
                updateShopDisplay();
                updateUpgradeIcons();
                
                alert(`Articles of Confederation purchased! Your points multiplier is now ${articlesMultiplier.toFixed(2)}x!`);
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function buyStampAct() {
            if (points >= stampActPrice) {
                points -= stampActPrice;
                stampActOwned++;
                stampActBoost += 110; // Add 110% boost
                stampActPrice = Math.floor(stampActPrice * 2);
                
                document.getElementById('points').textContent = formatNumber(points);
                updateShopDisplay();
                updateUpgradeIcons();
                
                alert(`Stamp Act purchased! You now have +${stampActBoost}% bonus to point gain!`);
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function buyWW1() {
            if (points >= ww1Price) {
                points -= ww1Price;
                ww1Owned++;
                ww1PointsPerOrder += 100; // Add 100 flat points
                ww1Price = Math.floor(ww1Price * 1.5);
                
                document.getElementById('points').textContent = formatNumber(points);
                updateShopDisplay();
                updateUpgradeIcons();
                
                alert(`World War I purchased! You now earn +${ww1PointsPerOrder} bonus points per order!`);
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        // Buy Max functions
        function buyMaxBillOfRights() {
            let purchased = 0;
            while (points >= billOfRightsPrice) {
                points -= billOfRightsPrice;
                billOfRightsOwned++;
                pointMultiplier *= 2;
                billOfRightsPrice = Math.floor(billOfRightsPrice * 2);
                purchased++;
                
                // Award badge on first purchase
                if (billOfRightsOwned === 1 && !billOfRightsBadgeEarned) {
                    billOfRightsBadgeEarned = true;
                    addBillOfRightsBadge();
                }
            }
            
            if (purchased > 0) {
                document.getElementById('points').textContent = formatNumber(points);
                updateShopDisplay();
                updateUpgradeIcons();
                alert(`Purchased ${purchased} Bill of Rights! Your point multiplier is now ${pointMultiplier}x!`);
                
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function buyMaxArticles() {
            let purchased = 0;
            while (points >= articlesPrice) {
                points -= articlesPrice;
                articlesOwned++;
                articlesMultiplier *= 1.25;
                
                // Every 10 purchases, multiply price by 10, otherwise add 10K
                if (articlesOwned % 10 === 0) {
                    articlesPrice = Math.floor(articlesPrice * 10);
                } else {
                    articlesPrice += 10000;
                }
                
                purchased++;
            }
            
            if (purchased > 0) {
                document.getElementById('points').textContent = formatNumber(points);
                updateShopDisplay();
                updateUpgradeIcons();
                alert(`Purchased ${purchased} Articles of Confederation! Your points multiplier is now ${articlesMultiplier.toFixed(2)}x!`);
                
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function buyMaxStampAct() {
            let purchased = 0;
            while (points >= stampActPrice) {
                points -= stampActPrice;
                stampActOwned++;
                stampActBoost += 110;
                stampActPrice = Math.floor(stampActPrice * 2);
                purchased++;
            }
            
            if (purchased > 0) {
                document.getElementById('points').textContent = formatNumber(points);
                updateShopDisplay();
                updateUpgradeIcons();
                alert(`Purchased ${purchased} Stamp Acts! You now have +${stampActBoost}% bonus to point gain!`);
                
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function buyMaxWW1() {
            let purchased = 0;
            while (points >= ww1Price) {
                points -= ww1Price;
                ww1Owned++;
                ww1PointsPerOrder += 100;
                ww1Price = Math.floor(ww1Price * 1.5);
                purchased++;
            }
            
            if (purchased > 0) {
                document.getElementById('points').textContent = formatNumber(points);
                updateShopDisplay();
                updateUpgradeIcons();
                alert(`Purchased ${purchased} World War I upgrades! You now earn +${ww1PointsPerOrder} bonus points per order!`);
                
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function buyBTD1() {
            if (btd1Owned) {
                alert('You already own Bloon Tower Defense 1!');
                return;
            }
            
            if (points >= 100000) {
                points -= 100000;
                btd1Owned = true;
                gemChance = 0.05;
                
                document.getElementById('points').textContent = formatNumber(points);
                document.getElementById('btd1Button').disabled = true;
                document.getElementById('btd1Button').textContent = 'OWNED';
                
                // Show gems stat box
                document.getElementById('gemsStatBox').style.display = 'block';
                
                alert('Bloon Tower Defense 1 purchased! You now have a 5% chance to earn gems with each order!');
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough O\'Brien Points!');
            }
        }

        function addNoahBadge() {
            const achievementsSection = document.getElementById('achievementsSection');
            const badgesContainer = document.getElementById('badgesContainer');
            
            achievementsSection.style.display = 'block';
            
            // Check if badge already exists
            if (document.getElementById('noahBadge')) return;
            
            const badge = document.createElement('div');
            badge.id = 'noahBadge';
            badge.className = 'badge';
            badge.innerHTML = `
                <span class="badge-icon">üèÖ</span>
                <span>Noah Roland</span>
            `;
            badgesContainer.appendChild(badge);
        }

        // Shop tab switching
        function switchShopTab(tab) {
            const regularTab = document.querySelector('.shop-tab:first-child');
            const gemTab = document.getElementById('gemShopTab');
            const regularShop = document.getElementById('regularShop');
            const gemShop = document.getElementById('gemShop');
            
            if (tab === 'regular') {
                regularTab.classList.add('active');
                gemTab.classList.remove('active');
                regularShop.classList.add('active');
                gemShop.classList.remove('active');
            } else if (tab === 'gem') {
                gemTab.classList.add('active');
                regularTab.classList.remove('active');
                gemShop.classList.add('active');
                regularShop.classList.remove('active');
            }
            updateGemShopDisplay();
        }

        function updateGemShopDisplay() {
            document.getElementById('franksPrice').textContent = formatNumber(franksKFCPrice) + ' Gems';
            document.getElementById('franksCount').textContent = franksKFCOwned;
        }

        // Gem animation
        function showGemAnimation() {
            const gemAnim = document.createElement('div');
            gemAnim.className = 'gem-animation';
            gemAnim.textContent = 'üíé';
            
            // Position near the gems stat box
            const gemsBox = document.getElementById('gemsStatBox');
            const rect = gemsBox.getBoundingClientRect();
            gemAnim.style.left = (rect.left + rect.width / 2) + 'px';
            gemAnim.style.top = (rect.top + rect.height / 2) + 'px';
            
            document.body.appendChild(gemAnim);
            
            // Remove after animation
            setTimeout(() => {
                gemAnim.remove();
            }, 1500);
        }

        // Gem shop purchases
        function buyFranks() {
            if (gems >= franksKFCPrice) {
                gems -= franksKFCPrice;
                franksKFCOwned++;
                gemMultiplier++;
                franksKFCPrice = Math.floor(franksKFCPrice * 1.8);
                
                // Award badge on first purchase
                if (!franksKFCBadgeEarned) {
                    franksKFCBadgeEarned = true;
                    addFranksBadge();
                }
                
                document.getElementById('gems').textContent = formatNumber(gems);
                updateGemShopDisplay();
                
                let message = `Franks KFC purchased! Your gem multiplier is now ${gemMultiplier}x!`;
                if (franksKFCOwned === 1) {
                    message += '\n\nAchievement Unlocked: "Gem Collector"!';
                }
                alert(message);
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough Gems!');
            }
        }

        function addFranksBadge() {
            const achievementsSection = document.getElementById('achievementsSection');
            const badgesContainer = document.getElementById('badgesContainer');
            
            achievementsSection.style.display = 'block';
            
            // Check if badge already exists
            if (document.getElementById('franksBadge')) return;
            
            const badge = document.createElement('div');
            badge.id = 'franksBadge';
            badge.className = 'badge';
            badge.innerHTML = `
                <span class="badge-icon">üçó</span>
                <span>Gem Collector</span>
            `;
            badgesContainer.appendChild(badge);
        }

        function buyKevin() {
            if (kevinBaldHeadOwned) {
                alert('You already own Kevins Shiny Bald Head!');
                return;
            }
            
            if (gems >= 50) {
                gems -= 50;
                kevinBaldHeadOwned = true;
                
                document.getElementById('gems').textContent = formatNumber(gems);
                document.getElementById('kevinButton').disabled = true;
                document.getElementById('kevinButton').textContent = 'OWNED';
                
                // Show second order area
                document.getElementById('secondOrderArea').style.display = 'block';
                
                // Initialize the second order display
                document.getElementById('orderDisplay2').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666;">
                        <p style="font-size: 1.2em;">üöÄ Second Order Station Ready!</p>
                        <p>Click "Start New Order" to begin</p>
                    </div>
                `;
                
                // Add badge
                if (!kevinBaldHeadBadgeEarned) {
                    kevinBaldHeadBadgeEarned = true;
                    addKevinBadge();
                }
                
                alert('Kevins Shiny Bald Head purchased! You now have a second order starter that works 1.5x faster!\n\nAchievement Unlocked: "Double Trouble"!');
                
                // Auto-save if user is logged in
                if (currentUser) {
                    saveProgress();
                    updateUserStats();
                }
            } else {
                alert('Not enough Gems!');
            }
        }

        function addKevinBadge() {
            const achievementsSection = document.getElementById('achievementsSection');
            const badgesContainer = document.getElementById('badgesContainer');
            
            achievementsSection.style.display = 'block';
            
            // Check if badge already exists
            if (document.getElementById('kevinBadge')) return;
            
            const badge = document.createElement('div');
            badge.id = 'kevinBadge';
            badge.className = 'badge';
            badge.innerHTML = `
                <span class="badge-icon">üòé</span>
                <span>Double Trouble</span>
            `;
            badgesContainer.appendChild(badge);
        }

        // Second order area functions
        function startMakingOrder2() {
            if (currentOrder2) return;
            
            currentOrder2 = generateRandomOrder();
            progress2 = 0;
            
            document.getElementById('makeButton2').disabled = true;
            document.getElementById('completeButton2').disabled = true;

            displayOrder2();
            startProgress2();
        }

        function displayOrder2() {
            const orderDisplay = document.getElementById('orderDisplay2');
            orderDisplay.innerHTML = `
                <div class="current-order">
                    <h3>üìã Current Order (1.5x Faster):</h3>
                    <ul class="order-items">
                        ${currentOrder2.map(item => `<li><span>${item}</span><span>‚úì</span></li>`).join('')}
                    </ul>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressFill2" style="width: 0%">
                            Making... 0%
                        </div>
                    </div>
                </div>
            `;
        }

        function startProgress2() {
            progressInterval2 = setInterval(() => {
                progress2 += 3; // 1.5x faster (2 * 1.5 = 3)
                const progressFill = document.getElementById('progressFill2');
                progressFill.style.width = progress2 + '%';
                progressFill.textContent = `Making... ${progress2}%`;

                if (progress2 >= 100) {
                    clearInterval(progressInterval2);
                    progressFill.textContent = 'Ready!';
                    document.getElementById('completeButton2').disabled = false;
                }
            }, 50);
        }

        function completeOrder2() {
            if (!currentOrder2) return;

            let ordersToAdd = 1 * orderMultiplier;
            ordersCompleted += ordersToAdd;
            
            let pointsToAdd = 1 * pointMultiplier * articlesMultiplier;
            
            // Apply Stamp Act boost (percentage)
            if (stampActBoost > 0) {
                pointsToAdd *= (1 + stampActBoost / 100);
            }
            
            // Apply World War I flat bonus
            pointsToAdd += ww1PointsPerOrder;
            
            // Apply Brecken bonus (10x points)
            if (currentUser && currentUser.toLowerCase() === 'brecken') {
                pointsToAdd *= 10;
            }
            
            points += pointsToAdd;
            
            // Gem chance if BTD1 owned
            let gemEarned = false;
            let gemsEarnedAmount = 0;
            if (btd1Owned && Math.random() < 0.05) {
                gemsEarnedAmount = 1 * gemMultiplier;
                gems += gemsEarnedAmount;
                gemEarned = true;
                document.getElementById('gems').textContent = formatNumber(gems);
                
                // Show gem animation
                showGemAnimation();
                
                // Show gem shop tab if this is the first gem
                if (gems >= 1) {
                    document.getElementById('gemShopTab').style.display = 'block';
                }
            }
            
            document.getElementById('orders').textContent = formatNumber(ordersCompleted);
            document.getElementById('points').textContent = formatNumber(points);
            
            // Add pulse animation
            document.getElementById('points').classList.add('pulse');
            setTimeout(() => {
                document.getElementById('points').classList.remove('pulse');
            }, 500);

            currentOrder2 = null;
            let bonusText = (currentUser && currentUser.toLowerCase() === 'brecken') ? ' (10x Brecken Bonus!)' : '';
            let gemText = gemEarned ? `<p style="color: #9c27b0; font-weight: bold;">üíé +${gemsEarnedAmount} Gem${gemsEarnedAmount > 1 ? 's' : ''} earned!</p>` : '';
            document.getElementById('orderDisplay2').innerHTML = `
                <div style="text-align: center; padding: 40px;">
                    <h3 style="color: #4caf50; font-size: 1.5em; margin-bottom: 10px;">‚úÖ Order Complete!</h3>
                    <p style="color: #666;">+${formatNumber(pointsToAdd)} O'Brien Point${pointsToAdd > 1 ? 's' : ''} earned!${bonusText}</p>
                    <p style="color: #666;">+${ordersToAdd} Order${ordersToAdd > 1 ? 's' : ''} completed!</p>
                    ${gemText}
                </div>
            `;

            document.getElementById('completeButton2').disabled = true;
            document.getElementById('makeButton2').disabled = false;

            document.getElementById('completeButton2').disabled = true;
            document.getElementById('makeButton2').disabled = false;

            // Auto-save if user is logged in
            if (currentUser) {
                saveProgress();
                updateUserStats();
            }
        }

        // Account System Functions
        function openAccount() {
            document.getElementById('accountModal').style.display = 'block';
            if (currentUser) {
                showLoggedInView();
                updateUserStats();
            } else {
                showAuthView();
            }
        }

        function closeAccount() {
            document.getElementById('accountModal').style.display = 'none';
            hideMessages();
        }

        function switchTab(tab) {
            const loginTab = document.querySelector('.tab-button:first-child');
            const signupTab = document.querySelector('.tab-button:last-child');
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            
            hideMessages();
            
            if (tab === 'login') {
                loginTab.classList.add('active');
                signupTab.classList.remove('active');
                loginForm.classList.add('active');
                signupForm.classList.remove('active');
            } else {
                signupTab.classList.add('active');
                loginTab.classList.remove('active');
                signupForm.classList.add('active');
                loginForm.classList.remove('active');
            }
        }

        function handleSignup(event) {
            event.preventDefault();
            hideMessages();
            
            const username = document.getElementById('signupUsername').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupPasswordConfirm').value;
            
            // Validate username
            const validation = validateUsername(username);
            if (!validation.valid) {
                showError(validation.message);
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Passwords do not match!');
                return;
            }
            
            // Check if username already exists
            const accounts = JSON.parse(localStorage.getItem('obrienAccounts') || '{}');
            if (accounts[username]) {
                showError('Username already exists!');
                return;
            }
            
            // Create new account
            accounts[username] = {
                password: password,
                createdAt: new Date().toISOString()
            };
            
            localStorage.setItem('obrienAccounts', JSON.stringify(accounts));
            
            showSuccess('Account created successfully! You can now login.');
            
            // Clear form
            document.getElementById('signupForm').reset();
            
            // Switch to login tab after 1.5 seconds
            setTimeout(() => {
                switchTab('login');
            }, 1500);
        }

        function handleLogin(event) {
            event.preventDefault();
            hideMessages();
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const accounts = JSON.parse(localStorage.getItem('obrienAccounts') || '{}');
            
            if (!accounts[username]) {
                showError('Account not found!');
                return;
            }
            
            if (accounts[username].password !== password) {
                showError('Incorrect password!');
                return;
            }
            
            // Login successful
            currentUser = username;
            localStorage.setItem('currentUser', username);
            
            // Load user's saved progress
            loadProgress();
            
            // If Brecken and no title set, set Creator as default
            if (currentUser.toLowerCase() === 'brecken' && !selectedTitle) {
                selectedTitle = 'creator';
            }
            
            // Clear form
            document.getElementById('loginForm').reset();
            
            // Immediately switch to profile view
            hideMessages();
            showLoggedInView();
            startAutoSave();
            showLoggedInHeader();
        }

        function handleLogout() {
            if (confirm('Are you sure you want to logout? Your progress is saved.')) {
                saveProgress();
                localStorage.removeItem('currentUser');
                currentUser = null;
                
                // Stop auto-save
                if (autoSaveInterval) {
                    clearInterval(autoSaveInterval);
                }
                
                showAuthView();
                closeAccount();
                hideLoggedInHeader();
                
                // Reset game to default state
                resetGameState();
            }
        }

        function checkLoggedInUser() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const accounts = JSON.parse(localStorage.getItem('obrienAccounts') || '{}');
                if (accounts[savedUser]) {
                    currentUser = savedUser;
                    loadProgress();
                    startAutoSave();
                    showLoggedInHeader();
                }
            }
        }

        function saveProgress() {
            if (!currentUser) return;
            
            const saveData = {
                points: points,
                gems: gems,
                ordersCompleted: ordersCompleted,
                billOfRightsOwned: billOfRightsOwned,
                billOfRightsPrice: billOfRightsPrice,
                pointMultiplier: pointMultiplier,
                billOfRightsBadgeEarned: billOfRightsBadgeEarned,
                declarationOwned: declarationOwned,
                articlesOwned: articlesOwned,
                articlesPrice: articlesPrice,
                articlesMultiplier: articlesMultiplier,
                stampActOwned: stampActOwned,
                stampActPrice: stampActPrice,
                stampActBoost: stampActBoost,
                ww1Owned: ww1Owned,
                ww1Price: ww1Price,
                ww1PointsPerOrder: ww1PointsPerOrder,
                btd1Owned: btd1Owned,
                gemChance: gemChance,
                stevenBradleyOwned: stevenBradleyOwned,
                noahRolandOwned: noahRolandOwned,
                orderMultiplier: orderMultiplier,
                hasShownBillOfRights: hasShownBillOfRights,
                selectedTitle: selectedTitle,
                franksKFCOwned: franksKFCOwned,
                franksKFCPrice: franksKFCPrice,
                gemMultiplier: gemMultiplier,
                franksKFCBadgeEarned: franksKFCBadgeEarned,
                kevinBaldHeadOwned: kevinBaldHeadOwned,
                kevinBaldHeadBadgeEarned: kevinBaldHeadBadgeEarned,
                lastSaved: new Date().toISOString()
            };
            
            localStorage.setItem(`obrienSave_${currentUser}`, JSON.stringify(saveData));
            
            // Sync leaderboard data to Firebase
            syncToLeaderboard();
            
            // Update last save time display if profile is open
            updateLastSaveTime();
        }
        
        // Sync player data to Firebase leaderboard
        function syncToLeaderboard() {
            if (!currentUser || !firebaseEnabled) return;
            
            try {
                const leaderboardData = {
                    username: currentUser,
                    orders: ordersCompleted,
                    points: points,
                    gems: gems,
                    title: selectedTitle || 'none',
                    lastUpdated: Date.now()
                };
                
                // Use username as key to prevent duplicates
                const sanitizedUsername = currentUser.replace(/[.#$[\]]/g, '_');
                database.ref('leaderboard/' + sanitizedUsername).set(leaderboardData);
            } catch (error) {
                console.error("Error syncing to leaderboard:", error);
            }
        }

        function loadProgress() {
            if (!currentUser) return;
            
            const saveData = JSON.parse(localStorage.getItem(`obrienSave_${currentUser}`));
            
            if (saveData) {
                points = saveData.points || 0;
                gems = saveData.gems || 0;
                ordersCompleted = saveData.ordersCompleted || 0;
                billOfRightsOwned = saveData.billOfRightsOwned || 0;
                billOfRightsPrice = saveData.billOfRightsPrice || 10;
                pointMultiplier = saveData.pointMultiplier || 1;
                billOfRightsBadgeEarned = saveData.billOfRightsBadgeEarned || false;
                declarationOwned = saveData.declarationOwned || false;
                articlesOwned = saveData.articlesOwned || 0;
                articlesPrice = saveData.articlesPrice || 10000;
                articlesMultiplier = saveData.articlesMultiplier || 1;
                stampActOwned = saveData.stampActOwned || 0;
                stampActPrice = saveData.stampActPrice || 50000;
                stampActBoost = saveData.stampActBoost || 0;
                ww1Owned = saveData.ww1Owned || 0;
                ww1Price = saveData.ww1Price || 2000;
                ww1PointsPerOrder = saveData.ww1PointsPerOrder || 0;
                btd1Owned = saveData.btd1Owned || false;
                gemChance = saveData.gemChance || 0;
                stevenBradleyOwned = saveData.stevenBradleyOwned || false;
                noahRolandOwned = saveData.noahRolandOwned || false;
                orderMultiplier = saveData.orderMultiplier || 1;
                hasShownBillOfRights = saveData.hasShownBillOfRights || false;
                selectedTitle = saveData.selectedTitle || getDefaultTitle();
                franksKFCOwned = saveData.franksKFCOwned || 0;
                franksKFCPrice = saveData.franksKFCPrice || 5;
                gemMultiplier = saveData.gemMultiplier || 1;
                franksKFCBadgeEarned = saveData.franksKFCBadgeEarned || false;
                kevinBaldHeadOwned = saveData.kevinBaldHeadOwned || false;
                kevinBaldHeadBadgeEarned = saveData.kevinBaldHeadBadgeEarned || false;
                
                // Update display
                document.getElementById('points').textContent = formatNumber(points);
                document.getElementById('orders').textContent = formatNumber(ordersCompleted);
                document.getElementById('gems').textContent = formatNumber(gems);
                
                // Show gems stat if BTD1 owned
                if (btd1Owned) {
                    document.getElementById('gemsStatBox').style.display = 'block';
                    document.getElementById('btd1Button').disabled = true;
                    document.getElementById('btd1Button').textContent = 'OWNED';
                }
                
                // Show gem shop tab if player has at least 1 gem
                if (gems >= 1) {
                    document.getElementById('gemShopTab').style.display = 'block';
                }
                
                // Restore Bill of Rights badge if earned
                if (billOfRightsBadgeEarned) {
                    addBillOfRightsBadge();
                }
                
                // Restore Bill of Rights icons
                updateBORIcons();
                
                // Restart declaration bot if owned
                if (declarationOwned) {
                    startDeclarationBot();
                    addDeclarationBadge();
                    document.getElementById('doiButton').disabled = true;
                    document.getElementById('doiButton').textContent = 'OWNED';
                }
                updateBotsDisplay();
                
                // Restart Steven Bradley sound if owned
                if (stevenBradleyOwned) {
                    startStevenSound();
                    document.getElementById('stevenButton').disabled = true;
                    document.getElementById('stevenButton').textContent = 'OWNED';
                }
                
                // Restore Noah Roland badge
                if (noahRolandOwned) {
                    addNoahBadge();
                    document.getElementById('noahButton').disabled = true;
                    document.getElementById('noahButton').textContent = 'OWNED';
                }
                
                // Restore Franks KFC badge
                if (franksKFCBadgeEarned) {
                    addFranksBadge();
                }
                
                // Restore Kevin's Bald Head
                if (kevinBaldHeadOwned) {
                    document.getElementById('secondOrderArea').style.display = 'block';
                    document.getElementById('kevinButton').disabled = true;
                    document.getElementById('kevinButton').textContent = 'OWNED';
                    addKevinBadge();
                    
                    // Initialize the second order display if not already in progress
                    if (!currentOrder2) {
                        document.getElementById('orderDisplay2').innerHTML = `
                            <div style="text-align: center; padding: 20px; color: #666;">
                                <p style="font-size: 1.2em;">üöÄ Second Order Station Ready!</p>
                                <p>Click "Start New Order" to begin</p>
                            </div>
                        `;
                    }
                }
                
                updateShopDisplay();
                updateGemShopDisplay();
                updateTitleDisplay();
            } else {
                // New player - set default title
                selectedTitle = getDefaultTitle();
                updateTitleDisplay();
            }
        }

        function resetGameState() {
            // Clear declaration bot
            if (declarationBotInterval) {
                clearInterval(declarationBotInterval);
                declarationBotInterval = null;
            }
            
            // Clear Steven sound
            if (stevenInterval) {
                clearInterval(stevenInterval);
                stevenInterval = null;
            }
            
            // Reset all values
            points = 0;
            gems = 0;
            ordersCompleted = 0;
            billOfRightsOwned = 0;
            billOfRightsPrice = 10;
            pointMultiplier = 1;
            billOfRightsBadgeEarned = false;
            declarationOwned = false;
            articlesOwned = 0;
            articlesPrice = 10000;
            articlesMultiplier = 1;
            stampActOwned = 0;
            stampActPrice = 50000;
            stampActBoost = 0;
            ww1Owned = 0;
            ww1Price = 2000;
            ww1PointsPerOrder = 0;
            btd1Owned = false;
            gemChance = 0;
            stevenBradleyOwned = false;
            noahRolandOwned = false;
            orderMultiplier = 1;
            franksKFCOwned = 0;
            franksKFCPrice = 5;
            gemMultiplier = 1;
            franksKFCBadgeEarned = false;
            kevinBaldHeadOwned = false;
            kevinBaldHeadBadgeEarned = false;
            hasShownBillOfRights = false;
            currentOrder = null;
            selectedTitle = null;
            
            // Update display
            document.getElementById('points').textContent = points;
            document.getElementById('orders').textContent = ordersCompleted;
            document.getElementById('gems').textContent = gems;
            document.getElementById('gemsStatBox').style.display = 'none';
            document.getElementById('borIcons').innerHTML = '';
            document.getElementById('botsSection').style.display = 'none';
            document.getElementById('achievementsSection').style.display = 'none';
            document.getElementById('badgesContainer').innerHTML = '';
            document.getElementById('orderDisplay').innerHTML = '';
            document.getElementById('stevenButton').disabled = false;
            document.getElementById('stevenButton').textContent = 'Buy';
            document.getElementById('noahButton').disabled = false;
            document.getElementById('noahButton').textContent = 'Buy';
            document.getElementById('doiButton').disabled = false;
            document.getElementById('doiButton').textContent = 'Buy';
            document.getElementById('btd1Button').disabled = false;
            document.getElementById('btd1Button').textContent = 'Buy';
            document.getElementById('makeButton').disabled = false;
            document.getElementById('completeButton').disabled = true;
        }

        function startAutoSave() {
            // Auto-save every 10 seconds
            autoSaveInterval = setInterval(() => {
                saveProgress();
            }, 10000);
        }

        function showLoggedInView() {
            document.getElementById('authView').classList.remove('active');
            document.getElementById('loggedInView').classList.add('active');
            document.getElementById('currentUsername').textContent = currentUser;
            
            // Show Brecken badge if applicable
            if (currentUser && currentUser.toLowerCase() === 'brecken') {
                document.getElementById('breckenBadge').style.display = 'inline-block';
                document.getElementById('adminPanel').style.display = 'block';
            } else {
                document.getElementById('breckenBadge').style.display = 'none';
                document.getElementById('adminPanel').style.display = 'none';
            }
            
            updateTitleDisplay();
            updateUserStats();
        }

        function showAuthView() {
            document.getElementById('loggedInView').classList.remove('active');
            document.getElementById('authView').classList.add('active');
            hideMessages();
        }

        function updateUserStats() {
            // Update basic stats
            document.getElementById('userPoints').textContent = formatNumber(points);
            document.getElementById('userOrders').textContent = formatNumber(ordersCompleted);
            
            // Update gems if BTD1 owned
            if (btd1Owned) {
                document.getElementById('userGemsCard').style.display = 'block';
                document.getElementById('userGems').textContent = formatNumber(gems);
            }
            
            // Update multipliers
            document.getElementById('userPointMult').textContent = (pointMultiplier * articlesMultiplier).toFixed(2) + 'x';
            document.getElementById('userOrderMult').textContent = orderMultiplier + 'x';
            
            // Update owned items
            updateOwnedItems();
            
            // Update achievements
            updateProfileAchievements();
            
            // Update last save time
            updateLastSaveTime();
            
            // Update member since
            updateMemberSince();
            
            // Update title display (in case new titles unlocked)
            updateTitleDisplay();
        }

        function updateOwnedItems() {
            const itemsList = document.getElementById('ownedItemsList');
            itemsList.innerHTML = '';
            
            let hasItems = false;
            
            if (billOfRightsOwned > 0) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">üìú Bill of Rights</span>
                    <span class="item-count">x${billOfRightsOwned}</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (declarationOwned) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">üìÉ Declaration of Independence</span>
                    <span class="item-count">‚úì OWNED</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (articlesOwned > 0) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">üìÑ Articles of Confederation</span>
                    <span class="item-count">x${articlesOwned}</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (stampActOwned > 0) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">üìÆ Stamp Act</span>
                    <span class="item-count">x${stampActOwned}</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (ww1Owned > 0) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">ü™ñ World War I</span>
                    <span class="item-count">x${ww1Owned}</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (btd1Owned) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">üéÆ Bloon Tower Defense 1</span>
                    <span class="item-count">‚úì OWNED</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (stevenBradleyOwned) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">üîä Steven Bradley</span>
                    <span class="item-count">‚úì OWNED</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (noahRolandOwned) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">üèÖ Noah Roland Badge</span>
                    <span class="item-count">‚úì UNLOCKED</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (franksKFCOwned > 0) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">üçó Franks KFC</span>
                    <span class="item-count">x${franksKFCOwned}</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (kevinBaldHeadOwned) {
                hasItems = true;
                const item = document.createElement('div');
                item.className = 'owned-item';
                item.innerHTML = `
                    <span class="item-name">üòé Kevins Shiny Bald Head</span>
                    <span class="item-count">‚úì OWNED</span>
                `;
                itemsList.appendChild(item);
            }
            
            if (!hasItems) {
                itemsList.innerHTML = '<p style="color: #999; text-align: center;">No items purchased yet</p>';
            }
        }

        function updateProfileAchievements() {
            const achievementsProfile = document.getElementById('achievementsProfile');
            const profileBadges = document.getElementById('profileBadges');
            
            let badges = '';
            
            if (billOfRightsBadgeEarned) {
                badges += `
                    <div class="badge">
                        <span class="badge-icon">üìú</span>
                        <span>Constitutional Scholar</span>
                    </div>
                `;
            }
            
            if (declarationOwned) {
                badges += `
                    <div class="badge">
                        <span class="badge-icon">üìÉ</span>
                        <span>Founding Father</span>
                    </div>
                `;
            }
            
            if (noahRolandOwned) {
                badges += `
                    <div class="badge">
                        <span class="badge-icon">üèÖ</span>
                        <span>Noah Roland</span>
                    </div>
                `;
            }
            
            if (badges) {
                achievementsProfile.style.display = 'block';
                profileBadges.innerHTML = badges;
            } else {
                achievementsProfile.style.display = 'none';
            }
        }

        function updateLastSaveTime() {
            const saveData = JSON.parse(localStorage.getItem(`obrienSave_${currentUser}`));
            if (saveData && saveData.lastSaved) {
                const lastSaved = new Date(saveData.lastSaved);
                const now = new Date();
                const diffSeconds = Math.floor((now - lastSaved) / 1000);
                
                let timeText;
                if (diffSeconds < 60) {
                    timeText = 'Just now';
                } else if (diffSeconds < 3600) {
                    const minutes = Math.floor(diffSeconds / 60);
                    timeText = `${minutes} minute${minutes > 1 ? 's' : ''} ago`;
                } else if (diffSeconds < 86400) {
                    const hours = Math.floor(diffSeconds / 3600);
                    timeText = `${hours} hour${hours > 1 ? 's' : ''} ago`;
                } else {
                    timeText = lastSaved.toLocaleDateString() + ' ' + lastSaved.toLocaleTimeString();
                }
                
                document.getElementById('lastSaveTime').textContent = timeText;
            } else {
                document.getElementById('lastSaveTime').textContent = 'Never';
            }
        }

        function updateMemberSince() {
            const accounts = JSON.parse(localStorage.getItem('obrienAccounts') || '{}');
            if (accounts[currentUser] && accounts[currentUser].createdAt) {
                const createdDate = new Date(accounts[currentUser].createdAt);
                document.getElementById('memberSince').textContent = 'Member since: ' + createdDate.toLocaleDateString();
            } else {
                document.getElementById('memberSince').textContent = 'Member since: Unknown';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
        }

        function hideMessages() {
            document.getElementById('errorMessage').style.display = 'none';
            document.getElementById('successMessage').style.display = 'none';
        }

        function showLoggedInHeader() {
            const status = document.getElementById('loggedInStatus');
            const username = document.getElementById('headerUsername');
            status.classList.add('active');
            username.textContent = currentUser;
        }

        function hideLoggedInHeader() {
            const status = document.getElementById('loggedInStatus');
            status.classList.remove('active');
        }

        // Title system functions
        function openTitleSelector() {
            document.getElementById('titleModal').style.display = 'block';
            renderTitles();
        }

        function closeTitleSelector() {
            document.getElementById('titleModal').style.display = 'none';
        }

        function renderTitles() {
            const titlesList = document.getElementById('titlesList');
            titlesList.innerHTML = '';
            
            titles.forEach(title => {
                const isUnlocked = isTitleUnlocked(title);
                const isSelected = selectedTitle === title.id;
                const isBrecken = currentUser && currentUser.toLowerCase() === 'brecken';
                
                // Show Creator title only for Brecken
                if (title.id === 'creator' && !isBrecken) {
                    return;
                }
                
                const titleItem = document.createElement('div');
                titleItem.className = `title-item ${isSelected ? 'selected' : ''} ${!isUnlocked ? 'locked' : ''}`;
                
                if (isUnlocked) {
                    titleItem.onclick = () => selectTitle(title.id);
                }
                
                titleItem.innerHTML = `
                    <div class="title-item-header">
                        <span class="title-name">${title.name}</span>
                        <span class="title-badge ${!isUnlocked ? 'locked-badge' : ''}">${isSelected ? 'EQUIPPED' : (isUnlocked ? 'UNLOCKED' : 'LOCKED')}</span>
                    </div>
                    <div class="title-requirement">${title.requirementText}</div>
                `;
                
                titlesList.appendChild(titleItem);
            });
        }

        function isTitleUnlocked(title) {
            if (title.id === 'none') return true;
            if (title.id === 'creator') {
                return currentUser && currentUser.toLowerCase() === 'brecken';
            }
            return ordersCompleted >= title.requirement;
        }

        function selectTitle(titleId) {
            const title = titles.find(t => t.id === titleId);
            if (!title || !isTitleUnlocked(title)) return;
            
            selectedTitle = titleId;
            updateTitleDisplay();
            renderTitles();
            saveProgress();
        }

        function updateTitleDisplay() {
            const titleDisplay = document.getElementById('userTitleDisplay');
            const title = titles.find(t => t.id === selectedTitle);
            
            if (title && title.id !== 'none') {
                titleDisplay.textContent = `"${title.name}" - Click to change title`;
                titleDisplay.style.color = '#9c27b0';
            } else {
                titleDisplay.textContent = 'Click to select a title';
                titleDisplay.style.color = '#999';
            }
        }

        function getDefaultTitle() {
            // Brecken gets Creator by default
            if (currentUser && currentUser.toLowerCase() === 'brecken') {
                return 'creator';
            }
            return 'none';
        }

        // Username change functions
        function openUsernameChange() {
            document.getElementById('usernameChangeModal').style.display = 'block';
            document.getElementById('currentUsernameDisplay').textContent = currentUser;
            document.getElementById('newUsername').value = '';
            document.getElementById('usernameChangePassword').value = '';
            hideUsernameChangeMessages();
        }

        function closeUsernameChange() {
            document.getElementById('usernameChangeModal').style.display = 'none';
            hideUsernameChangeMessages();
        }

        function hideUsernameChangeMessages() {
            document.getElementById('usernameChangeError').style.display = 'none';
            document.getElementById('usernameChangeSuccess').style.display = 'none';
        }

        function showUsernameChangeError(message) {
            const errorDiv = document.getElementById('usernameChangeError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('usernameChangeSuccess').style.display = 'none';
        }

        function showUsernameChangeSuccess(message) {
            const successDiv = document.getElementById('usernameChangeSuccess');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            document.getElementById('usernameChangeError').style.display = 'none';
        }

        function changeUsername() {
            const newUsername = document.getElementById('newUsername').value.trim();
            const password = document.getElementById('usernameChangePassword').value;
            
            hideUsernameChangeMessages();
            
            if (!newUsername || !password) {
                showUsernameChangeError('Please fill in all fields.');
                return;
            }
            
            // Validate new username
            const validation = validateUsername(newUsername);
            if (!validation.valid) {
                showUsernameChangeError(validation.message);
                return;
            }
            
            // Can't change to the same username
            if (newUsername === currentUser) {
                showUsernameChangeError('This is already your username!');
                return;
            }
            
            // Verify password
            const accounts = JSON.parse(localStorage.getItem('obrienAccounts') || '{}');
            if (!accounts[currentUser] || accounts[currentUser].password !== password) {
                showUsernameChangeError('Incorrect password!');
                return;
            }
            
            // Check if new username already exists
            if (accounts[newUsername]) {
                showUsernameChangeError('Username already taken!');
                return;
            }
            
            // Save old username for cleanup
            const oldUsername = currentUser;
            
            // Get current save data
            const saveData = JSON.parse(localStorage.getItem(`obrienSave_${oldUsername}`) || '{}');
            
            // Create new account with same password
            accounts[newUsername] = {
                password: accounts[oldUsername].password,
                createdAt: accounts[oldUsername].createdAt
            };
            
            // Delete old account
            delete accounts[oldUsername];
            
            // Save updated accounts
            localStorage.setItem('obrienAccounts', JSON.stringify(accounts));
            
            // Move save data to new username
            localStorage.setItem(`obrienSave_${newUsername}`, JSON.stringify(saveData));
            localStorage.removeItem(`obrienSave_${oldUsername}`);
            
            // Update current user
            currentUser = newUsername;
            localStorage.setItem('currentUser', newUsername);
            
            // Delete old Firebase entry and create new one
            if (firebaseEnabled) {
                try {
                    const sanitizedOldUsername = oldUsername.replace(/[.#$[\]]/g, '_');
                    database.ref('leaderboard/' + sanitizedOldUsername).remove();
                    syncToLeaderboard();
                } catch (error) {
                    console.error("Error updating Firebase username:", error);
                }
            }
            
            // Update displays
            document.getElementById('currentUsername').textContent = newUsername;
            document.getElementById('headerUsername').textContent = newUsername;
            
            showUsernameChangeSuccess('‚úÖ Username changed successfully!');
            
            setTimeout(() => {
                closeUsernameChange();
                updateUserStats();
            }, 1500);
        }

        // Leaderboard functions
        function openLeaderboard() {
            document.getElementById('leaderboardModal').style.display = 'block';
            
            // Show Firebase status
            const statusDiv = document.getElementById('leaderboardStatus');
            if (firebaseEnabled) {
                statusDiv.innerHTML = 'üåê <strong>Global Leaderboard</strong> - Showing all players worldwide in real-time!';
                statusDiv.style.background = 'linear-gradient(135deg, #4caf50 0%, #45a049 100%)';
                statusDiv.style.color = 'white';
            } else {
                statusDiv.innerHTML = '‚ö†Ô∏è <strong>Firebase Not Connected</strong> - See DATABASE_RULES_SETUP.md to enable global leaderboard. Check browser console (F12) for errors.';
                statusDiv.style.background = '#fff3cd';
                statusDiv.style.color = '#856404';
            }
            
            loadLeaderboard();
        }

        function closeLeaderboard() {
            document.getElementById('leaderboardModal').style.display = 'none';
        }

        function loadLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboardBody');
            leaderboardBody.innerHTML = '<tr><td colspan="5" class="no-data-message">Loading leaderboard...</td></tr>';

            if (firebaseEnabled) {
                // Load from Firebase
                loadFirebaseLeaderboard();
            } else {
                // Load from localStorage
                loadLocalLeaderboard();
            }
        }
        
        function loadFirebaseLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboardBody');
            
            database.ref('leaderboard').once('value')
                .then((snapshot) => {
                    const leaderboardData = [];
                    
                    snapshot.forEach((childSnapshot) => {
                        const player = childSnapshot.val();
                        leaderboardData.push(player);
                    });
                    
                    // Sort by orders (descending)
                    leaderboardData.sort((a, b) => b.orders - a.orders);
                    
                    // Take top 50
                    const top50 = leaderboardData.slice(0, 50);
                    
                    displayLeaderboard(top50, leaderboardBody);
                })
                .catch((error) => {
                    console.error("Error loading Firebase leaderboard:", error);
                    leaderboardBody.innerHTML = '<tr><td colspan="5" class="no-data-message">Error loading leaderboard. Please try again.</td></tr>';
                });
        }
        
        function loadLocalLeaderboard() {
            const leaderboardBody = document.getElementById('leaderboardBody');
            const leaderboardData = [];

            // Get all accounts
            const accounts = JSON.parse(localStorage.getItem('obrienAccounts') || '{}');

            // Collect data from all accounts
            for (const username in accounts) {
                const saveData = JSON.parse(localStorage.getItem(`obrienSave_${username}`) || '{}');
                
                leaderboardData.push({
                    username: username,
                    orders: saveData.ordersCompleted || 0,
                    points: saveData.points || 0,
                    gems: saveData.gems || 0,
                    title: saveData.selectedTitle || 'none'
                });
            }

            // Sort by orders (descending)
            leaderboardData.sort((a, b) => b.orders - a.orders);

            // Take top 50
            const top50 = leaderboardData.slice(0, 50);

            displayLeaderboard(top50, leaderboardBody);
        }
        
        function displayLeaderboard(players, leaderboardBody) {
            leaderboardBody.innerHTML = '';
            
            if (players.length === 0) {
                leaderboardBody.innerHTML = '<tr><td colspan="5" class="no-data-message">No players yet! Be the first to join!</td></tr>';
                return;
            }

            // Render leaderboard
            players.forEach((player, index) => {
                const rank = index + 1;
                const isCurrentUser = currentUser && player.username === currentUser;
                
                let rankClass = '';
                let trophyIcon = '';
                if (rank === 1) {
                    rankClass = 'rank-1';
                    trophyIcon = 'ü•á ';
                } else if (rank === 2) {
                    rankClass = 'rank-2';
                    trophyIcon = 'ü•à ';
                } else if (rank === 3) {
                    rankClass = 'rank-3';
                    trophyIcon = 'ü•â ';
                }

                const titleObj = titles.find(t => t.id === player.title);
                const titleDisplay = titleObj && titleObj.id !== 'none' 
                    ? `<span class="leaderboard-title">"${titleObj.name}"</span>` 
                    : '';

                const row = document.createElement('tr');
                if (isCurrentUser) {
                    row.className = 'current-user-row';
                }

                row.innerHTML = `
                    <td class="${rankClass}">
                        <span class="leaderboard-rank">
                            <span class="trophy-icon">${trophyIcon}</span>${rank}
                        </span>
                    </td>
                    <td>
                        <span class="leaderboard-username">${escapeHtml(player.username)}</span>
                        ${titleDisplay}
                        ${isCurrentUser ? ' <strong style="color: #2196f3;">(You)</strong>' : ''}
                    </td>
                    <td><strong>${formatNumber(player.orders)}</strong></td>
                    <td>${formatNumber(player.points)}</td>
                    <td>${formatNumber(player.gems || 0)}</td>
                `;

                leaderboardBody.appendChild(row);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================
        // ADMIN FUNCTIONS (Brecken Only)
        // ==========================================
        
        function adminResetUserPoints() {
            // Verify admin access
            if (!currentUser || currentUser.toLowerCase() !== 'brecken') {
                alert('‚õî Access Denied: Admin privileges required!');
                return;
            }
            
            const targetUsername = document.getElementById('adminResetUsername').value.trim();
            
            if (!targetUsername) {
                alert('‚ùå Please enter a username!');
                return;
            }
            
            // Check if user exists
            const accounts = JSON.parse(localStorage.getItem('obrienAccounts') || '{}');
            if (!accounts[targetUsername]) {
                alert(`‚ùå User "${targetUsername}" does not exist!`);
                return;
            }
            
            // Confirm action
            const confirmed = confirm(
                `‚ö†Ô∏è ADMIN ACTION ‚ö†Ô∏è\n\n` +
                `Are you sure you want to reset ALL POINTS for user "${targetUsername}"?\n\n` +
                `This will set their O'Brien Points to 0!\n\n` +
                `This action cannot be undone!`
            );
            
            if (!confirmed) {
                return;
            }
            
            // Load user's save data
            const saveKey = `obrienSave_${targetUsername}`;
            const saveData = JSON.parse(localStorage.getItem(saveKey) || '{}');
            
            if (!saveData || Object.keys(saveData).length === 0) {
                alert(`‚ùå No save data found for "${targetUsername}"!`);
                return;
            }
            
            // Reset only the points
            saveData.points = 0;
            
            // Save back to localStorage
            localStorage.setItem(saveKey, JSON.stringify(saveData));
            
            // If this is the current user, update their display
            if (currentUser === targetUsername) {
                points = 0;
                document.getElementById('points').textContent = '0';
                document.getElementById('userPoints').textContent = '0';
                saveProgress();
            }
            
            // Sync to Firebase if enabled
            if (firebaseEnabled && database) {
                try {
                    const sanitizedUsername = targetUsername.replace(/[.#$[\]]/g, '_');
                    database.ref('leaderboard/' + sanitizedUsername + '/points').set(0);
                } catch (error) {
                    console.error('Failed to sync to Firebase:', error);
                }
            }
            
            alert(`‚úÖ SUCCESS!\n\nUser "${targetUsername}" points have been reset to 0!`);
            document.getElementById('adminResetUsername').value = '';
        }

        // Export/Import Save Data Functions
        function exportSaveData() {
            if (!currentUser) {
                alert('You must be logged in to export save data!');
                return;
            }

            // Gather all data
            const exportData = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                username: currentUser,
                accountData: JSON.parse(localStorage.getItem('obrienAccounts') || '{}')[currentUser],
                saveData: JSON.parse(localStorage.getItem(`obrienSave_${currentUser}`) || '{}')
            };

            // Create blob and download
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `obrien-save-${currentUser}-${Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            alert('Save data exported successfully! You can now import this file on any device.');
        }

        function importSaveData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importData.version || !importData.username) {
                        alert('Invalid save file format! Missing required fields.');
                        return;
                    }

                    if (!importData.saveData || typeof importData.saveData !== 'object') {
                        alert('Invalid save file format! Save data is missing or corrupted.');
                        return;
                    }

                    // Validate username format
                    let username = importData.username.trim();
                    if (username.length < 1 || username.length > 50) {
                        alert('Invalid username in save file!');
                        return;
                    }
                    
                    // Validate username content
                    let finalUsername = username;
                    const validation = validateUsername(username);
                    if (!validation.valid) {
                        alert('Invalid username in save file: ' + validation.message + '\n\nThe username will be sanitized.');
                        // Sanitize the username by removing invalid characters
                        finalUsername = username.replace(/[^a-zA-Z0-9_-]/g, '_').substring(0, 20);
                        if (finalUsername.length < 3) {
                            finalUsername = 'imported_' + Math.random().toString(36).substring(7);
                        }
                    }

                    // Check if username already exists
                    const accounts = JSON.parse(localStorage.getItem('obrienAccounts') || '{}');
                    
                    // If username exists, ask user what to do
                    if (accounts[finalUsername]) {
                        const overwrite = confirm(`Account "${finalUsername}" already exists.\n\nClick OK to OVERWRITE the existing account.\nClick Cancel to import as a NEW account with a different name.`);
                        
                        if (!overwrite) {
                            // Find available username
                            let counter = 1;
                            while (accounts[`${finalUsername}_${counter}`]) {
                                counter++;
                            }
                            finalUsername = `${finalUsername}_${counter}`;
                        }
                    }

                    // Prepare account data
                    const accountData = importData.accountData || {
                        password: 'imported' + Math.random().toString(36).substring(7),
                        createdAt: importData.exportDate || new Date().toISOString()
                    };

                    // Save account data
                    accounts[finalUsername] = accountData;
                    localStorage.setItem('obrienAccounts', JSON.stringify(accounts));

                    // Save game data
                    localStorage.setItem(`obrienSave_${finalUsername}`, JSON.stringify(importData.saveData));

                    // Show success message with details
                    const pointsImported = formatNumber(importData.saveData.points || 0);
                    const ordersImported = formatNumber(importData.saveData.ordersCompleted || 0);
                    const gemsImported = formatNumber(importData.saveData.gems || 0);
                    
                    alert(`‚úÖ Save data imported successfully!\n\nUsername: ${finalUsername}\nO'Brien Points: ${pointsImported}\nOrders: ${ordersImported}\nGems: ${gemsImported}\n\n${finalUsername === username ? 'Account data has been updated!' : 'A new account has been created!'}\n\nYou can now log in to continue playing.`);
                    
                    // If currently logged in, log out
                    if (currentUser) {
                        saveProgress();
                        localStorage.removeItem('currentUser');
                        currentUser = null;
                        if (autoSaveInterval) {
                            clearInterval(autoSaveInterval);
                        }
                        showAuthView();
                        hideLoggedInHeader();
                        resetGameState();
                    }
                    
                    closeAccount();
                    
                } catch (error) {
                    alert('‚ùå Error importing save data!\n\n' + error.message + '\n\nMake sure you selected a valid save file exported from this game.');
                    console.error('Import error:', error);
                }
            };
            
            reader.readAsText(file);
            
            // Reset file input
            event.target.value = '';
        }
    </script>
</body>
</html>
